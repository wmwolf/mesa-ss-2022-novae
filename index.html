<html lang="en">
<head>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css" media="screen, print">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">

  <!-- Custom CSS -->
  <link rel="stylesheet" type="text/css" href="/css/syntax2.css" media="screen, print">
  <link rel="stylesheet" type="text/css" href="/css/extras.css" media="screen, print">

  <style type=text/css media=print>
    .no-print {
      display:  none;
    }

    html, body {
      height: auto;
    }
    </style>

</head>

  <meta name="keywords" content="Nova, White Dwarf, MESA"/>
  <title>MESA SS 2022: Recurrent Novae and Steady Burning</title>
</head>

<body id='mesa-ss-body'>
  <div class="splash-nova">
    <h1 class='display-3'>Recurrent Novae and Steady Burning</h1>
  </div>
  <div class="container mt-4">
    <div class="row">
      <div class="col-md-3 sticky-top align-self-start d-none d-md-block" id="super-side-nav">
        <ul class="nav nav-pills flex-columns list-group" id="side-nav">
  <li class="nav-item">
    <a class="nav-link part-header h5" href="#overview">Overview</a>
  </li>
  <li class="nav-item">
    <a class="nav-link part-header h5" href="#part0">Background</a>
  </li>
  <li class="nav-item">
    <a class="nav-link part-header h5" href="#part1"
      >Minilab 1: Getting Set Up</a
    >
    <nav class="nav nav-pills flex-column sub-parts" id="part1-subparts">
      <a class="nav-link ml-3 my-1" href="#part1a">Starting from a Test Case</a>
      <a class="nav-link ml-3 my-1" href="#part1b">Structure of a Test Case</a>
      <a class="nav-link ml-3 my-1" href="#part1c"
        >Building a Steadily-Burning Model</a
      >
      <a class="nav-link ml-3 my-1" href="#part1d">Conclusion</a>
      <!-- <a class="nav-link ml-3 my-1" href="#part1d">Compiling, Running, and Restarting</a> -->
    </nav>
  </li>
  <li class="nav-item">
    <a class="nav-link part-header h5" href="#part2"
      >Minilab 2: Customizing pgstar</a
    >
    <nav class="nav nav-pills flex-column sub-parts" id="part2-subparts">
      <a class="nav-link ml-3 my-1" href="#part2a"
        >The Stock <samp>pgstar</samp> Panel</a
      >
      <a class="nav-link ml-3 my-1" href="#part2b">Pointing to a New Inlist</a>
      <a class="nav-link ml-3 my-1" href="#part2c">Updating the Dashboard</a>
      <a class="nav-link ml-3 my-1" href="#part2d"
        >(Bonus) Adding an Extra History Column</a
      >
      <a class="nav-link ml-3 my-1" href="#part2e">Conclusion</a>
    </nav>
  </li>
  <li class="nav-item">
    <a class="nav-link part-header h5" href="#part3"
      >Maxilab: The Stability Boundary</a
    >
    <nav class="nav nav-pills flex-column sub-parts" id="part3-subparts">
      <a class="nav-link ml-3 my-1" href="#part3a">Updating M&#775;</a>
      <a class="nav-link ml-3 my-1" href="#part3b">Resolving the SSS Phase</a>
      <a class="nav-link ml-3 my-1" href="#part3c">Changing the Wind Scheme</a>
    </nav>
  </li>
  <li class="nav-item">
    <a class="nav-link part-header h5" href="#part4">Discussion</a>
  </li>
</ul>

      </div>
      <div class="col-12 col-md-9" data-spy="scroll" data-target="#side-nav" data-offset="0" id="mesa-ss-instructions">
        <h2 id='overview'> Overview </h2>
<p>
  This guide is meant to supplement the afternoon session of day 1 of the
  <a href="https://mesahub.github.io/summer-school-2022" target=_blank>
    2022 MESA Summer School
  </a>
  at the
  <a href="https://ucsb.edu" target=_blank>
    University of California, Santa Barbara
  </a> in August 2022. The labs were designed by
  <a href="https://billwolf.space" target=_blank>Bill Wolf</a> and
  Ebraheem Farag. The science case is loosely based on simulations in <a href="https://ui.adsabs.harvard.edu/abs/2013ApJ...777..136W/abstract" target=_blank>Wolf et al. 2013</a>.
</p>
<h3>Requirements</h3>
<p>
  If you are completing this tutorial after the official summer school, you
  should use the following versions of <samp>MESA</samp> and the SDK:
</p>
<dl class="row">
  <dt class="col-4 col-sm-3 col-xl-2">MESA Version</dt>
  <dd class="col-8 col-sm-9 col-xl-10">2022.05.1</dd>

  <dt class="col-4 col-sm-3 col-xl-2">SDK Version</dt>
  <dd class="col-8 col-sm-9 col-xl-10">2022.6.2 (Intel Mac) <em>or</em> 22.6.1 (Linux and ARM Mac)</dd>
</dl>
<p>
  These exercises <em>may</em> work or be adapted to older or newer releases,
  but there is no such expectation for them to work.
</p>

<h3>What You'll Learn</h3>
<p>
  The primary purpose of this lab is to get you more familiar with some topics
  in <samp>MESA</samp> beyond the absolute basics, including:
</p>
<ul>
  <li>Starting a project from a test case</li>
  <li>Customizing <samp>pgstar</samp> output</li>
  <li>Performing basic convergence studies</li>
  <li>Modifying controls mid-simulation using <samp>run_star_extras.f90</samp></li>
  <li>Implementing custom physics using the <samp>other_adjust_mdot</samp> hook</li>
</ul>
<p>
  We'll do all this while studying the topic of rapidly-accreting white dwarf
  stars. Even if this topic is of little scientific interest to you, it will be
  a useful playground in which to learn the skills above.
</p>
<h3>Using this Guide</h3>
<p>
  Throughout this guide, monospaced text on a black background, like this:
  <kbd>echo "Hello, World!"</kbd> represent commands you can type into your
  terminal and execute, while red monospaced text like this:
  <code>mass_change = 1d-9</code> represent file names or values that you might
  type into a file, but not something to be executed.
</p>


<h2 id='part0' class='mt-5'>Background</h2>
<p>
  Recurrent novae are thermonuclear flashes on the surfaces of rapidly-accreting massive white dwarfs. They are similar to classical novae, but they have been observed in outburst multiple times. In general, the more massive a white dwarf is, the shorter the recurrence time (time between successive flashes) will be. Similarly, the higher the accretion rate Ṁ, the shorter the recurrence time will be.
</p>

<p>
  There is a limit to how high Ṁ can be before the nova will find an equilibrium solution and burn material at the same rate it is accreted. There is some debate as to whether this could physically occur (perhaps the accretion doesn't return after the initial flash or is never stable enough over long enough timescales, etc.). For now, we will assume that accretion resumes immediately after the initial "explosion", and we will see that stable burning does occur for sufficiently high Ṁ in <samp>MESA</samp>.
</p>
<p>
  Our main goal is to find the transition Ṁ where this occurs, and we'll see that we need to be careful with our simulation if we want a consistent result.
</p>

<h2 id="part1" class='mt-5'> Minilab 1: Getting Started</h2>
<p>
  In this first minilab, we'll get a <samp>MESA</samp> project up and running
  that we will use for the rest of the labs. You'll learn/practice the following
  skills:
</p>
<ul>
  <li>Starting a project from a test case</li>
  <li>Changing inlist controls</li>
  <li>Toggling <samp>pgstar</samp> displays on and off</li>
</ul>
<h4 id="part1a" class='mt-4'>Starting from a Test Case</h4>
<p>
  The test suites in <samp>MESA star</samp> (located in <code>$MESA_DIR/star/test_suite</code>), <samp>MESA binary</samp> (located in <code>$MESA_DIR/binary/test_suite</code>), and <samp>MESA astero</samp> (you get the idea) help detect bugs in development by checking that the behavior of a known application doesn't change substantially as commits are made. They are also useful as starting points for your own projects. We'll do that in this exercise.
</p>

<p class='lead bg-secondary p-2'>
  <span class='font-weight-bold text-primary'>Challenge 1.1:</span> Copy the <code>wd_nova_burst</code> test case from <samp>MESA star</samp> into a new directory outside of the installation, and call it <code>wolf</code>.
</p>
<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-1p1" aria-expanded="true" aria-controls="sol-1p1">
      Show Solution 1.1
    </button>
  </div>
  <div class="card-body collapse" id="sol-1p1">
    <p class="card-text">
      Assuming your <code>MESA_DIR</code> is set up correctly, execute the
      following in the terminal
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cp</span> <span class="nt">-r</span> <span class="s2">"</span><span class="nv">$MESA_DIR</span><span class="s2">/star/test_suite/wd_nova_burst"</span> <span class="s2">"~/wolf"</span></code></pre></figure>
      Though you may choose to place <code>wolf</code> somewhere other than
      your home directory.
    </p>
    <h4 class='card-text'>Explanation</h4>
    <p class='card-text'>
      <kbd>cp</kbd> is a command that takes two arguments. The first is a source file, and the second is the target. It copies the source file to the target file, creating the target if necessary. The <kbd>-r</kbd> option means to do this recursively, so we can then use <kbd>cp -r</kbd> to copy entire directories.
    </p>
  </div>
</div>
<p>
  Because this is a test case, some inlists, makefiles, and executable scripts will set their own <code>MESA_DIR</code> variable such that the test case will ignore whatever you have set as your environment variable. This makes the test case work perfectly fine in its normal home, even if you haven't set <code>MESA_DIR</code>, but outside of that location, it wreaks havoc. We need to fix this.
</p>
<p class='lead bg-secondary p-2'>
  <span class='font-weight-bold text-primary'>Challenge 1.2:</span> Delete all
  assignments to <code>MESA_DIR</code> or <code>mesa_dir</code> from the test case.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-1p2a" aria-expanded="true" aria-controls="hint-1p2a">
      Show Hint 1.2a: Finding Lines With <samp>grep</samp>
    </button>
  </div>
  <div class="card-body collapse" id="hint-1p2a">
    <p class='card-text'>
      The command-line tool <samp>grep</samp> lets you hunt for text in files. The general way it works is something like <br/>
      <kbd>grep <em>SEARCH_STRING</em> <em>FILE_GLOB</em></kbd>.<br/>
      Here, <samp><em>SEARCH_STRING</em></samp> is the text or pattern you are searching for, and <samp><em>FILE_GLOB</em></samp> is some pattern of files to search. As a more concrete (and useful) example, try executing the following:
    </p>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell">  <span class="nb">grep </span>mesa_dir inlist<span class="k">*</span></code></pre></figure>
    <p class='card-text'>
      This should show two instances where <code>mesa_dir</code> is set:
    </p>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell">inlist_setup_header:      mesa_dir <span class="o">=</span> <span class="s1">'../../..'</span>
inlist_wd_nova_burst_header:      mesa_dir <span class="o">=</span> <span class="s1">'../../..'</span></code></pre></figure>
    <p class="card-text">
      So at the very least, we need to delete some lines in these two inlist
      files.
    </p>

    <p class="card-text">
      For even more power, <samp>grep</samp> lets you search recursively (search an entire directory, and any directories within it) with the <code>-r</code> option, or in a case-insensitive search with the <code>-i</code> options. Go ahead and give the following a try:
    </p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">  <span class="nb">grep</span> <span class="nt">-ri</span> mesa_dir .</code></pre></figure>
    <p class="card-text">
      This searches all files in the current directory, including files inside of enclosed directories, for <samp>mesa_dir</samp> in a case-insensitive manner.
    </p>

    <p class="card-text">
      Remember, we only want to comment out or delete lines that
      <strong class="font-weight-bold">assign</strong> <samp>mesa_dir</samp>/<samp>MESA_DIR</samp>. We
      <strong class="font-weight-bold">don't</strong> want to delete lines that simply
      <strong class="font-weight-bold">use</strong> it.
    </p>
  </div>
</div>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-1p2b" aria-expanded="true" aria-controls="hint-1p2b">
      Show Hint 1.2b: What Files do I Edit?
    </button>
  </div>
  <div class="card-body collapse" id="hint-1p2b">
    <p class='card-text'>
      Look in the following for any lines that set <code>MESA_DIR</code> or <code>mesa_dir</code> and comment out or delete them:
    </p>
    <ul class='card-text'>
      <li><code>make/makefile</code></li>
      <li><code>inlist_setup_header</code></li>
      <li><code>inlist_wd_nova_burst_header</code></li>
      <li><code>rn</code></li>
    </ul>
    <p class='card-text'>
     If you don't do this, compilation will look in the wrong place for your
     installation, and/or the <code>star</code> executable won't be able to find
     the right data at runtime.
  </p>
  </div>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-1p2" aria-expanded="true" aria-controls="sol-1p2">
      Show Solution 1.2
    </button>
  </div>
  <div class="card-body collapse" id="sol-1p2">
    <p class="card-text">
      Comment out or delete the following lines:
    </p>
    <ul class='card-text'>
      <li><code>make/makefile</code>: line 2</li>
      <li><code>inlist_setup_header</code>: line 4</li>
      <li><code>inlist_wd_nova_burst_header</code>: line 4</li>
      <li><code>rn</code>: line 5</li>
    </ul>
    <p class="card-text">
      There's another line in <code>ck</code>, but that file is part of the
      testing infrastructure, so we can ignore it.
    </p>
  </div>
</div>

<div class="card border-secondary mb-3 text-secondary">
  <div class="card-header bg-secondary">
    <h5 class='card-title mb-0'>Why Do We Have To Do This?</h5>
  </div>
  <div class="card-body">
    <p class="card-text">
      As mentioned before, the test cases are set up this way so that, even if
      you have your own version of <code>MESA_DIR</code>, they can compile and
      run properly in their normal home (e.g. <code>star/test_suite/wd_nova_burst</code>). In later releases, this may
      be changed, and you may not need to make these adjustments.
    </p>
  </div>
</div>

<h4 id="part1b" class='mt-4'>Structure of a Test Case</h4>
<p>
  Each test case is unique, but as you experiment with them, you'll notice several trends.
</p>
<h5 class='mt-3'>Multiple Inlists and Inlist Headers</h5>
<p>
  In this test case, we have a whopping five files that star with the word <code>inlist</code>. What's going on with this? Before diving into those, it first makes sense to look at the <code>rn</code> script. Open this file up again and look at it (it's also shown below). It is <em>not</em> the same as the typical <code>rn</code> script in the standard <samp>MESA</samp> work directory.
</p>
<h4 class="text-monospace">rn</h4>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#!/bin/bash</span>

<span class="c"># this provides the definition of do_one (run one part of test)</span>
<span class="c"># do_one [inlist] [output model] [LOGS directory]</span>
<span class="c"># MESA_DIR=../../..   ### This is commented out after the previous task</span>
<span class="nb">source</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MESA_DIR</span><span class="k">}</span><span class="s2">/star/test_suite/test_suite_helpers"</span>

<span class="nb">date</span> <span class="s2">"+DATE: %Y-%m-%d%nTIME: %H:%M:%S"</span>

do_one inlist_setup_header ready.mod
do_one inlist_wd_nova_burst_header final.mod

<span class="nb">date</span> <span class="s2">"+DATE: %Y-%m-%d%nTIME: %H:%M:%S"</span>

<span class="nb">echo</span> <span class="s1">'finished inlists'</span></code></pre></figure>
<p>
  The most interesting thing here are the <code>source</code> and two <code>do_one</code> statements. You can look at <code>$MESA_DIR/star/test_suite/test_suite_helpers</code> to see what is being hidden here, but the short of it is that it defines the function <code>do_one</code> that we use afterwards. This function takes in an inlist and an optional model file name (in the first case, <code>inlist_setup_header</code> and <code>ready.mod</code>) and does a few things with them:
</p>
<ol>
  <li>Copy the inlist to the file <code>inlist</code>, overwriting it.</li>
  <li>Call the star executable (essentially "do the run" with the current inlist)</li>
  <li>Optionally check for the existence of a model that should have come from the run, and exit with an error if it doesn't exist.</li>
</ol>
<p>
  So in <code>rn</code>, we're first running <code>inlist_setup_header</code>, then checking to make sure that the model it creates exists before going on to run <code>inlist_wd_nova_burst_header</code>. Through the copying action of the <code>do_one</code> function, we never directly interact with the file <code>inlist</code>. But why are there two inlists for each state (the header and the non-header versions)?
</p>
<p>
  Open up <code>inlist_setup_header</code> (also shown below) and inspect it.
</p>
<h4 class="text-monospace">inlist_setup_header</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="c1">!inlist_setup_header</span><span class="w">
</span><span class="p">&amp;</span><span class="n">star_job</span><span class="w">

      </span><span class="c1">! mesa_dir = '../../..' ! Commented out in Task 1.2</span><span class="w">

      </span><span class="n">read_extra_star_job_inlist2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
      </span><span class="n">extra_star_job_inlist2_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'inlist_setup'</span><span class="w">

</span><span class="p">/</span><span class="w"> </span><span class="c1">! end of star_job namelist</span><span class="w">


</span><span class="p">&amp;</span><span class="n">eos</span><span class="w">

      </span><span class="n">read_extra_eos_inlist1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
      </span><span class="n">extra_eos_inlist1_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'inlist_setup'</span><span class="w">

</span><span class="p">/</span><span class="w"> </span><span class="c1">! end of eos namelist</span><span class="w">


</span><span class="p">&amp;</span><span class="n">kap</span><span class="w">

      </span><span class="n">read_extra_kap_inlist1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
      </span><span class="n">extra_kap_inlist1_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'inlist_setup'</span><span class="w">

</span><span class="p">/</span><span class="w"> </span><span class="c1">! end of kap namelist</span><span class="w">



</span><span class="p">&amp;</span><span class="n">controls</span><span class="w">

      </span><span class="n">read_extra_controls_inlist2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
      </span><span class="n">extra_controls_inlist2_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'inlist_setup'</span><span class="w">

</span><span class="p">/</span><span class="w"> </span><span class="c1">! end of controls namelist</span><span class="w">



</span><span class="p">&amp;</span><span class="n">pgstar</span><span class="w">

      </span><span class="n">read_extra_pgstar_inlist2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
      </span><span class="n">extra_pgstar_inlist2_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'inlist_setup'</span><span class="w">

</span><span class="p">/</span><span class="w"> </span><span class="c1">! end of pgstar namelist</span></code></pre></figure>
<p>
  So all this inlist does is point to the "real" inlist. Why do we do this? Well, we don't <em>have</em> to, but in this way, there's only one "true" inlist. Even if you interrupt the run and then restart it, you can make changes to <code>inlist_setup</code> rather than directly to <code>inlist</code> (which is what you'd have to do if we directly copied <code>inlist_setup</code> to <code>inlist</code>).
</p>

<p>
  So now we can see why there are so many inlist-like files in this project. There are really only two that matter (so far): <code>inlist_setup</code> and <code>inlist_wd_nova_burst</code>. These correspond to two phases of the test that require different controls. Some test cases will have only one stage, and thus only one "real" inlist, while others can have five or more. For our purposes, <code>inlist_setup</code> is not particularly interesting; it does some housekeeping before the main show, which is in <code>inlist_wd_nova_burst</code>.
</p>
<h5 class='mt-3'>Restrictive Stopping Conditions</h5>
<p>
  Test cases are designed to fail quickly if something goes wrong. This can mean that there are aggressive restrictions on age, model numbers, total retries, cumulative errors in energy, or other quantities. This is useful for testing purposes, but often not useful when modifying a test case, which will necessarily "break" it.
</p>

<div class='bg-secondary mb-2 px-2 pt-2 pb-1'>
  <p class="lead">
    <span class='font-weight-bold text-primary'>Challenge 1.3:</span> Remove
    aggressive stopping condition(s) in <code>inlist_wd_nova_burst</code>.
  </p>
  <p>
    We will tune this model to go into a steady burning mode so we can let it run for a very long time. There are one or more settings in the <code>controls</code> namelist that will prevent this. See if you can figure out which one(s) they are and comment them out or delete them.
  </p>

</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-1p3" aria-expanded="true" aria-controls="sol-1p3">
      Show Solution 1.3
    </button>
  </div>
  <div class="card-body collapse" id="sol-1p3">
    <p class="card-text">
      The biggest issue here is the limit on the maximum model number:
    </p>
    <h4><span class="text-monospace">inlist_wd_nova_burst</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="p">&amp;</span><span class="n">controls</span><span class="w">

  </span><span class="c1">! limit max_model_number as part of test_suite</span><span class="w">
  </span><span class="c1">!max_model_number = 223</span><span class="w">
  </span><span class="n">max_model_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2250</span></code></pre></figure>
    <p>
      There are also a couple of controls dealing with the limit and hard limit for errors in energy coonservation. These won't end the run, though they may shrink
      timesteps in the interest of accurate energy conservation. They can stay.
    </p>

    <p>
      Another option might have been <code>min_timestep_limit</code>. However,
      this is set to <code>1d-12</code>, which means that if the timestep dips below 10<sup>–12</sup> <span class="font-weight-bold">seconds</span>, the simulation will end, and that's probably a good idea!
    </p>

    <p>
      Finally: it's not a problem, but you might also consider deleting/commenting out the three lines dealing with tracing relative energy error. This will declutter your terminal output since we don't really care about that in this project.
    </p>
  </div>
</div>

<p>
  In addition to controls in the inlists, we should also look to <code>run_star_extras.f90</code> to see if there is a custom stopping condition, since many test cases employ such things. In fact, there may be many unexpected things in this file, so it's always a good idea to check it out.
</p>

<p>
  Open up <code>src/run_star_extras.f90</code>. We won't analyze everything that's here (most is basically boilerplate code in every simulation). Note, though, the following lines near the top:
</p>
<h4><span class="text-monospace">src/run_star_extras.f90</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">num_bursts</span><span class="w">
  </span><span class="kt">logical</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">waiting_for_burst</span><span class="w">
  </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">L_burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d4</span><span class="p">,</span><span class="w"> </span><span class="n">L_between</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d3</span><span class="w"> </span><span class="c1">! Lsun units</span></code></pre></figure>

<p>
  These define variables that the simulation uses in some of the other functions/subroutines. The first two variables are defined at the beginning of the run in <code>extras_startup</code>, unless we are doing a restart, in which case they are loaded from the photo:
</p>

<h4><span class="text-monospace">src/run_star_extras.f90</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="k">subroutine</span><span class="w"> </span><span class="n">extras_startup</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">restart</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
     </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
     </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">restart</span><span class="w">
     </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
     </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">
     </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
     </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">
     </span><span class="k">call</span><span class="w"> </span><span class="n">test_suite_startup</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">restart</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">.not.</span><span class="w"> </span><span class="n">restart</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
        </span><span class="n">num_bursts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
        </span><span class="n">waiting_for_burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
     </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
  </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">extras_startup</span></code></pre></figure>
<p>
  And all four are used in <code>extras_check_model</code>:
</p>
<h4><span class="text-monospace">src/run_star_extras.f90</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="kt">integer</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">extras_check_model</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
   </span><span class="kt">integer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
   </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">
   </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
   </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">
   </span><span class="k">include</span><span class="w"> </span><span class="s1">'formats'</span><span class="w">
   </span><span class="n">extras_check_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keep_going</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">L_phot</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">L_burst</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">waiting_for_burst</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
         </span><span class="n">num_bursts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_bursts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="s1">'num_bursts'</span><span class="p">,</span><span class="w"> </span><span class="n">num_bursts</span><span class="w">
         </span><span class="n">waiting_for_burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.false.</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
   </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">L_phot</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">L_between</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_bursts</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">'have finished burst'</span><span class="w">
         </span><span class="n">extras_check_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terminate</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">termination_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_extras_check_model</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
      </span><span class="n">waiting_for_burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
   </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">extras_check_model</span></code></pre></figure>
<p>
  Wherever you see <code>s%</code>, that is accessing data in the stellar model (<code>s</code> is called the "star info structure"; more on this later). Basically these controls then say that if we are waiting for a burst and the photometric luminosity exceeds 10<sup>4</sup> L<sub>&#8857;</sub>, then we have entered a burst, and when it then goes below 10<sup>3</sup> L<sub>&#8857;</sub>, we have finished the burst. After one such burst, the simulation is ended.
</p>
<p>
  We want to give the simulation two bursts to determine if it is "stable" rather than just one. Also, since the accretion rate is so rapid, sometimes the luminosity doesn't drop low enough between bursts to be counted as finishing the first burst, so we need to make some changes to this code.
</p>

<p class='lead bg-secondary p-2'>
  <span class='font-weight-bold text-primary'>Challenge 1.4:</span> Edit
  <code>extras_check_model</code> so the simulation ends after two bursts rather
  than one.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-1p4" aria-expanded="true" aria-controls="sol-1p4">
      Show Solution 1.4
    </button>
  </div>
  <div class="card-body collapse" id="sol-1p4">
    <p class="card-text">
      In <code>src/run_star_extras.f90</code>, edit the line
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_bursts</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span></code></pre></figure>
    to
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_bursts</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span></code></pre></figure>
    </p>
  </div>
</div>

<p class='lead bg-secondary p-2'>
  <span class='font-weight-bold text-primary'>Challenge 1.5:</span>
  Edit <code>run_star_extras.f90</code> so that a burst "ends" after the
  luminosity drops below 5 &#215; 10<sup>3</sup> L<sub>&#8857;</sub> instead of
  1 &#215; 10<sup>3</sup> L<sub>&#8857;</sub>.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-1p5" aria-expanded="true" aria-controls="sol-1p5">
      Show Solution 1.5
    </button>
  </div>
  <div class="card-body collapse" id="sol-1p5">
    <p class="card-text">
      In <code>src/run_star_extras.f90</code>, edit the line
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">L_burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d4</span><span class="p">,</span><span class="w"> </span><span class="n">L_between</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d3</span><span class="w"> </span><span class="c1">! Lsun units</span></code></pre></figure>
  <p>
    to
  </p>

<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">L_burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d4</span><span class="p">,</span><span class="w"> </span><span class="n">L_between</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5d3</span><span class="w"> </span><span class="c1">! Lsun units</span></code></pre></figure>
  </div>
</div>

<p>
  Check that your solution compiles by executing <kbd>./mk</kbd>.
</p>

<p>
  With your modified test case working, let's move on to tweaking the inlists.
</p>

<h3 id="part1c" class='mt-4'>Building a Steadily Burning Model</h3>

<p>
  So far, we haven't really substantively changed anything in the test case other than modifying the stopping condition. Now we want to actually change how it works. We'll start by increasing the accretion rate, lowering the spatial resolution,
</p>

<div class="bg-secondary pt-2 px-2">
  <p class='lead bg-secondary'>
    <span class='font-weight-bold text-primary'>Challenge 1.6:</span>
    Edit <code>inlist_wd_nova_burst</code> and/or <code>inlist_setup</code> to make the following changes:
  </p>
  <ul class="lead">
    <li>
      it accretes at a rate of 3.5 &#215; 10<sup>–7</sup> M<sub>&#8857;</sub>/yr
    </li>
    <li>
      the spatial resolution is lowered; set <code>mesh_delta_coeff</code> to 3.0 (this is bad practice for science, but it will make simulations run faster)
    </li>
    <li>
      the nuclear network is set to the simpler <code>basic.net</code> (another bad idea scientifically, but this will also help speed up the runs)
    </li>
    <li>
      the <samp>pgstar</samp> grid defined in the <code>&pgstar</code> namelist is active and visible
    </li>
  </ul>
  <p class="lead pb-2">
    None of these changes will require adding new lines to either inlist; you can do this all by editing or uncommenting existing lines.
  </p>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-1p6a" aria-expanded="true" aria-controls="hint-1p6a">
      Show Hint 1.6a: Changing the Accretion Rate
    </button>
  </div>
  <div class="card-body collapse" id="hint-1p6a">
    <p class='card-text'>
      The control you want to change is <code>mass_change</code> in the <code>controls</code> namelist.
    </p>
    <p class="card-text">
      Remember, you can learn all about different controls by looking at the files in <code>$MESA_DIR/star/defaults</code> or via the
      <a href="https://docs.mesastar.org/en/release-r22.05.1/reference.html" target=_blank>online reference</a>.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-1p6b" aria-expanded="true" aria-controls="hint-1p6b">
      Show Hint 1.6b: Lowering the Spatial Resolution
    </button>
  </div>
  <div class="card-body collapse" id="hint-1p6b">
    <p class='card-text'>
      In both <code>inlist_setup</code> and <code>inlist_wd_nova_burst</code> in the <code>&controls</code> namelist, set <code>mesh_delta_coeff = 3.0</code>. This is more important in <code>inlist_wd_nova_burst</code>, but you can do it in <code>inlist_setup</code>, too. These controls exist in both, but they are set to 1.0 initially.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-1p6c" aria-expanded="true" aria-controls="hint-1p6c">
      Show Hint 1.6c: Setting the Nuclear Network
    </button>
  </div>
  <div class="card-body collapse" id="hint-1p6c">
    <p class='card-text'>
      The network is only set in <code>inlist_setup</code>, and is left alone in <code>inlist_wd_nova_burst</code>. There is a line in its <code>&star_job</code> namelist that sets the name of the network, and you should edit it to <code>"basic.net"</code>.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-1p6d" aria-expanded="true" aria-controls="hint-1p6d">
      Show Hint 1.6d: Activating <samp>pgstar</samp>
    </button>
  </div>
  <div class="card-body collapse" id="hint-1p6d">
    <p class='card-text'>
      Interestingly, the control you want here is <span class="font-weight-bold">not</span> in the <code>pgstar</code> namelist! It's the <code>pgstar_flag</code> control in the <code>star_job</code> namelist. That line should already be there; you just need to uncomment it.
    </p>
    <p class='card-text'>
      The controls in the <code>&pgstar</code> namelist define what type of
      plots will be displayed, but the <code>pgstar_flag</code> is the main
      switch that toggles plots on and off. More on what's in the
      <code>&pgstar</code> namelist in <a href="#part2">Minilab 2</a>
    </p>
  </div>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-1p6" aria-expanded="true" aria-controls="sol-1p6">
      Show Solution 1.6
    </button>
  </div>
  <div class="card-body collapse" id="sol-1p6">
    <p class="card-text">
      In the <code>&star_job</code> namelist in <code>inlist_wd_nova_burst</code> uncomment the line
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">       </span><span class="c1">!pgstar_flag = .true.</span></code></pre></figure>
    <p class="card-text">to become</p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">       </span><span class="n">pgstar_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span></code></pre></figure>
  <p class="card-text">
    And lower, in the <code>&controls</code> namelist of <code>inlist_wd_nova_burst</code>, the accretion rate
    and spatial resolution can be updated by editing the lines
  </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">      </span><span class="n">mass_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d-9</span><span class="w">
      </span><span class="c1">! lines omitted</span><span class="w">
      </span><span class="n">mesh_delta_coeff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span></code></pre></figure>
  <p class="card-text">to</p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">      </span><span class="n">mass_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.5d-7</span><span class="w">
      </span><span class="c1">! lines omitted</span><span class="w">
      </span><span class="n">mesh_delta_coeff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span></code></pre></figure>
  <p class="card-text">
    Finally, we update the nuclear network by editing <code>inlist_setup</code>. Specifically, we change the following line in the <code>&star_job</code> namelist:
  </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">new_net_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'cno_extras_o18_to_mg26_plus_fe56.net'</span></code></pre></figure>
  <p class="card-text">to</p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">new_net_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'basic.net'</span></code></pre></figure>
  </div>
</div>
<p>
  Our simulation is almost ready to run, but there's one issue. We are loading
  a white dwarf model that was prepared to accrete at 10<sup>–9</sup>
  M<sub>&#8857;</sub>/yr, but now we want it to accrete at a rate 350 times higher!
  While this might work, it would be a painful process requiring very short
  timesteps to allow the outer regions of the model to adjust to the new
  scenario. We'd like a way to slowly ramp up the accretion rate. Fortunately,
  <samp>MESA</samp> has just that sort of thing:
  <strong class="font-weight-bold">relaxation routines</strong>.
</p>
<p class='lead bg-secondary p-2'>
  <span class='text-primary font-weight-bold'>Challenge 1.7:</span> Search the
  <code>star_job</code> defaults for a set of controls that will allow us to
  slowly increase the accretion rate from zero to 3.5 &#215; 10<sup>–7</sup>
  M<sub>&#8857;</sub> over fifty timesteps, taking no more than 0.1 years per
  timestep. Set these controls in <code>inlist_wd_nova_burst</code>.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-1p7a" aria-expanded="true" aria-controls="hint-1p7a">
      Show Hint 1.7a: Where do I look for defaults?
    </button>
  </div>
  <div class="card-body collapse" id="hint-1p7a">
    <p class='card-text'>
      Within the <samp>MESA</samp> source, you can always look inside (or
      <kbd>grep</kbd> into)
      <code>$MESA_DIR/star/defaults/star_job.defaults</code>. Alternatively, you
      can find documentation generated from this file at
      <a href="https://docs.mesastar.org" target=_blank>docs.mesastar.org</a>.
      Inlist defaults are detailed in the "Reference" section.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-1p7b" aria-expanded="true" aria-controls="hint-1p7b">
      Show Hint 1.7b: The Main Flag
    </button>
  </div>
  <div class="card-body collapse" id="hint-1p7b">
    <p class='card-text'>
      The primary flag you want to set is called
      <code>relax_initial_mass_change</code>, which you should set to
      <code>.true.</code>. There are an additional four numerical controls you
      will also want to set.
    </p>
    <p class="card-text">
      You might also notice the very similar <code>relax_mass_change</code>
      (missing the word "initial"). This will do the same thing, except it will
      also trigger the relaxation process <em>on restarts</em>. We don't want to
      do that; we only want to relax the accretion rate when we first start the
      run, and then subsequent restarts can just go straight to the final
      accretion rate.
    </p>
  </div>
</div>
<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-1p7" aria-expanded="true" aria-controls="sol-1p7">
      Show Solution 1.7
    </button>
  </div>
  <div class="card-body collapse" id="sol-1p7">
    <p class="card-text">
      Add the following lines to the <code>star_job</code> namelist of
      <code>inlist_wd_nova_burst</code>:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="n">relax_initial_mass_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
</span><span class="n">relax_mass_change_min_steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="w">
</span><span class="n">relax_mass_change_max_yrs_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="w">
</span><span class="n">relax_mass_change_init_mdot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="n">relax_mass_change_final_mdot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.5d-7</span></code></pre></figure>
  </div>
</div>
<p class='lead bg-secondary p-2'>
  <span class='text-primary font-weight-bold'>Challenge 1.8:</span> Get your model running! Compile if you haven't already, and then start the simulation.
</p>
<p>
  After completing the setup inlist and the relaxation process, a
  <samp>pgstar</samp> window should open up. This may take a few minutes, but
  once it does, that means your simulation should be ready to run continuously.
  You may let it run or end the process once the pgstar window has appeared.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-1p8" aria-expanded="true" aria-controls="sol-1p8">
      Show Solution 1.8
    </button>
  </div>
  <div class="card-body collapse" id="sol-1p8">
    <p class="card-text">
      If you haven't already, compile your project with <kbd>./mk</kbd>. Then
      get things started with <kbd>./rn</kbd>. If you get any errors, go back
      and review the previous challenge solutions and look for any discrepancies
      with your files.
    </p>
    <p class="card-text">
      The <code>rn</code> script will first run off of
      <code>inlist_setup_header</code>, which shouldn't take more than a minute.
      Then, it should run off of <code>inlist_wd_nova_burst_header</code>,
      which should launch a pgstar window something like what is shown below.
    </p>
    <figure class='figure'>
      <img class="figure-img img-fluid rounded" alt='pgstar grid' src="images/pgstar_1p8.png">
      <figcaption class="figure-caption text-left">
        The <samp>pgstar</samp> grid that should open up a while after starting
        the run. Note that it must first get through the setup inlist as well
        as the relaxation process, so your window may not open for a few
        minutes.
      </figcaption>
    </figure>

    <p class="card-text">
      This simulation should run continuously (and likely slowly). You can let
      it run continuously until the luminosity and effective temperature are
      pretty consistent at roughly log <var>L</var>/L<sub>&#8857;</sub> ≈ 4.3
      and log T<sub>eff</sub> ≈ 5.8. At this point, you can stop the run with
      <kbd>CTRL-C</kbd>.
    </p>
  </div>
</div>

<h3 id='part1d' class="mt-4">Conclusion</h3>
<p>
  That's the end of this first minilab, but we'll pick up where we left off in the next one. If you weren't able to get your project working properly, or you're skipping ahead to minilab 2, download the zip file below, which has a complete working directory that need only be compiled and ran.
</p>

<div class="text-center mb-2">
  <a href="downloads/wolf_1.zip" download>
    <button class='btn btn-lg btn-info'>Download Completed Project</button>
  </a>
</div>

<h2 id="part2" class="mt-5">Minilab 2: Customizing pgstar</h2>
<p>
  This lab focuses on getting you more comfortable working with and customizing
  <samp>pgstar</samp> plots. In particular, you will:
</p>
<ul>
  <li>Learn the basic structure of the <samp>pgstar</samp> namelist</li>
  <li>Customize an incomplete <samp>pgstar</samp> dashboard
  <li>(Time Permitting) add a custom history column and use it in <samp>pgstar</samp></li>
</ul>
<p>
  <samp>pgstar</samp> is a built-in feature of <samp>MESA</samp> that allows
  for real-time graphical insight into how your model is evolving. While the
  plots it generates are usually not suitable for publication, being able to
  "see" your model evolve can be an invaluable tool in developing intuition and
  diagnosing issues. Additionally, you can easily string frames of
  <samp>pgstar</samp> output into a movie after a simulation, which is great
  for presentations and group meetings!
</p>

<p>
  <samp>pgstar</samp> is comprised of several building blocks that we can sort
  into several [slightly-overlapping] categories.
</p>
<dl class="row">
  <dt class="col-sm-3">History Plots</dt>
  <dd class="col-sm-9">
    Plots that show one or two quantities from the history output plotted
    against a monotonically-increasing quantity, like <samp>star_age</samp> or
    <samp>model_number</samp>. These quantities must all be saved in
    <code>history.data</code>, and the resolution will depend on how often data
    is written to <samp>history.data</samp>.
  </dd>
  <dt class="col-sm-3">Profile Plots</dt>
  <dd class="col-sm-9">
    Plots that show one or two quantities that <em>could</em> be output in
    profiles against another profile quantity, often pressure, mass coordinate,
    or radius. Note that these do <em>not</em> need to be in
    <code>profile.columns</code> since they do not need to persist over multiple
    steps.
  </dd>
  <dt class="col-sm-3">Special Plots</dt>
  <dd class="col-sm-9">
    A collection of "one-off" plots with special capabilities. Examples include
    Kippenhahn diagrams, echelle diagrams, a nuclear network diagram, and a
    temperature-density profile. These can often be customized to a degree, but
    they are not as flexible as profile and history plots.
  </dd>
  <dt class="col-sm-3">Text Summaries</dt>
  <dd class="col-sm-9">
    Grids of name/value pairs that show scalar values associated with the
    current timestep. Examples include model number luminosity, and helium core
    mass. No graphics here; just text.
  </dd>
</dl>
<p>
  Most often, you'll deal with a <span class="font-weight-bold">grid</span> or
  <span class="font-weight-bold">dashboard</span> that contains many individual
  single- or multi-panel plots and/or text summaries arranged into a single
  window. We'll explore this next.
</p>

<h3 id='part2a' class="mt-4">The Stock <samp>pgstar</samp> Dashboard</h3>
<p>
  Look inside <code>inlist_wd_nova_burst</code>, towards the bottom. You'll find
  the <code>pgstar</code> namelist, which is responsible for defining the
  output you saw at the end of the last minilab. The relevant contents are
  shown below for convenience.
</p>
<h4><span class="font-monospace">inlist_wd_nova_burst</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="p">&amp;</span><span class="n">pgstar</span><span class="w">

         </span><span class="n">Grid8_win_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
         </span><span class="n">Grid8_win_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w">
         </span><span class="n">Summary_Burn_xaxis_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'logxq'</span><span class="w">
         </span><span class="n">Summary_Burn_xaxis_reversed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
         </span><span class="n">Summary_Burn_xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-14</span><span class="w"> </span><span class="c1">! -101d0 ! only used if /= -101d0</span><span class="w">
         </span><span class="n">Summary_Burn_xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-3</span><span class="w"> </span><span class="c1">! -101d0 ! only used if /= -101d0</span><span class="w">
         </span><span class="n">Abundance_xaxis_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'logxq'</span><span class="w">
         </span><span class="n">Abundance_xaxis_reversed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
         </span><span class="n">Abundance_xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-14</span><span class="w"> </span><span class="c1">! -101d0 ! only used if /= -101d0</span><span class="w">
         </span><span class="n">Abundance_xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-3</span><span class="w"> </span><span class="c1">! -101d0 ! only used if /= -101d0</span><span class="w">

    </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'time_step_sec'</span><span class="w">
    </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'max_tau_conv'</span><span class="w">
    </span><span class="c1">!Text_Summary1_name(7,2) = 'cz_bot_radius'</span><span class="w">
    </span><span class="c1">!Text_Summary1_name(8,2) = 'cz_top_radius'</span><span class="w">

</span><span class="p">/</span><span class="w"> </span><span class="c1">! end of pgstar namelist</span></code></pre></figure>
<p>
  The top line is the most important. This tells <samp>MESA</samp> to display
  a pre-built grid called <code>Grid8</code>, which is defined in
  <code>$MESA_DIR/star/defaults/pgstar.defaults</code>. Open that file up and
  search for the section that defines <code>Grid8</code>.
</p>

<p>
  Here you can see how the grid is defined. We provide a width and aspect ratio
  for the window, essentially defining its size. The various
  <code>Grid8_xleft</code>, <code>Grid8_ybot</code> controls set up margins to
  keep the contents from overflowing the window. Then the grid is set up by
  setting numbers of rows, columns, and plots, as well as default values for the
  names, positions, and padding for these plots.
</p>

<p>
  After setting the defaults for all of these values, they are set to more
  reasonable values, and each plot of the grid is defined. For
  <code>Grid8</code> in particular, there are 3 columns, 14 rows, and a total of
  6 plots. How is this possible? Well, we can set individual plots to span
  multiple columns or rows, so the total number of plots should always be less
  than the product of the number of rows and columns.
</p>

<p>
  Now let's look at the settings for one of the constituent plots:
</p>

<h4><samp class="font-monospace">pgstar.defaults</samp> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">    </span><span class="n">Grid8_plot_name</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Summary_Burn'</span><span class="w">
    </span><span class="n">Grid8_plot_row</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="n">Grid8_plot_rowspan</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w">
    </span><span class="n">Grid8_plot_col</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="n">Grid8_plot_colspan</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">
    </span><span class="n">Grid8_plot_pad_left</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">
    </span><span class="n">Grid8_plot_pad_right</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.06</span><span class="w">
    </span><span class="n">Grid8_plot_pad_top</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">
    </span><span class="n">Grid8_plot_pad_bot</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.09</span><span class="w">
    </span><span class="n">Grid8_txt_scale_factor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7</span></code></pre></figure>

<p>
  All of these quantities are arrays, and we are setting the value at index 1,
  meaning this is what we will refer to as "plot 1". The name
  (<samp>Summary_Burn</samp>) refers to pre-defined plot found elsewhere in
  <code>pgstar.defaults</code> with many of its own settings. The rest of the
  controls define which row and column to start in, and how many rows/columns
  the plot should cover, and then some padding to make sure the plot doesn't
  overflow its bounds.
</p>

<p>
  After each of the plots are defined similarly, there is a small collection
  of controls governing file output. In addition to or instead of displaying
  live on-screen plots, <samp>pgstar</samp> can save a .png file for each
  timestep (or in this case, every fifth timestep, since the interval is set to
  five). If you want to make movies out of <samp>pgstar</samp> output, these
  controls will help you generate the individuall frames you'll need.
</p>

<p>
  By looking at the various values in the <code>Grid8_plot_name</code> array,
  we can see that this grid contains the following plots:
</p>
<ol>
  <li><samp>Summary_Burn</samp></li>
  <li><samp>Abundance</samp></li>
  <li><samp>HR</samp></li>
  <li><samp>TRho</samp></li>
  <li><samp>TRho_Profile</samp></li>
  <li><samp>Text_Summary1</samp></li>
</ol>

<p>
  As mentioned earlier, each of <em>these</em> plots can also be customized. In
  the <code>&pgstar</code> namelist of <code>inlist_wd_nova_burst</code>, we
  see a couple of lines that modify <samp>Summary_Burn</samp> by changing what
  quantity is used for the horizontal axis as well as reversing it. You can see
  how several of the other plots are tweaked as well, including changing a
  couple of values in the text summary.
</p>

<p>
  Now that we understand a bit more about how the <samp>pgstar</samp> display
  is being generated&#8230; let's throw it away and start with a fresh one!
</p>

<h3 class="mt-4" id="part2b">Pointing to a New Inlist</h3>
<p>
  In this part, we'll replace the dashboard that came with the test case with
  a custom (but incomplete) one. Download the file below and move it into your
  work directory (<samp>wolf</samp>).
</p>
<div class="text-center mb-2">
  <a href="inlist_pgstar" download>
    <button class='btn btn-lg btn-info'>Download <samp>inlist_pgstar</samp></button>
  </a>
</div>

<p>
  Now that you have our new <code>inlist_pgstar</code> in the work directory,
  let's tell <code>inlist_wd_nova_burst_header</code> to use it.
</p>

<p class='lead bg-secondary p-2'>
  <span class='text-primary font-weight-bold'>Challenge 2.1:</span>
  Edit <code>inlist_wd_nova_burst_header</code> (and
  <strong class='font-weight-bold'>not</strong>
  <code>inlist_wd_nova_burst</code>) so that it reads <samp>pgstar</samp>
  controls from <code>inlist_pgstar</code> rather than
  <code>inlist_wd_nova_burst</code>, and then copy the new header to
  <code>inlist</code>.
</p>

<p>
  Note that the copying to <code>inlist</code> is only necessary because we
  will restart from a photo rather than starting a fresh run. If we were going
  to rely on <code>rn</code>, it would have done the copying for us.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-2p1" aria-expanded="true" aria-controls="sol-2p1">
      Show Solution 2.1
    </button>
  </div>
  <div class="card-body collapse" id="sol-2p1">
    <p class="card-text">Edit <code>inlist_wd_nova_burst_header</code> from</p>
    <h4><span class="font-monospace">inlist_wd_nova_burst_header</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="p">&amp;</span><span class="n">pgstar</span><span class="w">

      </span><span class="n">read_extra_pgstar_inlist2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
      </span><span class="n">extra_pgstar_inlist2_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'inlist_wd_nova_burst'</span><span class="w">

</span><span class="p">/</span><span class="w"> </span><span class="c1">! end of pgstar namelist</span></code></pre></figure>
    <p class="card_text">to this:</p>
    <h4><span class="font-monospace">inlist_wd_nova_burst_header</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="p">&amp;</span><span class="n">pgstar</span><span class="w">

      </span><span class="n">read_extra_pgstar_inlist2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
      </span><span class="n">extra_pgstar_inlist2_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'inlist_pgstar'</span><span class="w">

</span><span class="p">/</span><span class="w"> </span><span class="c1">! end of pgstar namelist</span></code></pre></figure>
    <p class='card-text'>
      Once that is done, overwrite <code>inlist</code> via
      <kbd>cp inlist_wd_nova_burst_header inlist</kbd>.
    </p>
    <h4>Explanation</h4>
    <p class='card-text'>
      Now the <code>&pgstar</code> namelist in <code>inlist_wd_nova_burst</code>
      will <em>never be used</em>. Instead, we will use the one in
      <code>inlist_pgstar</code>. This is another reason why header style
      inlists can be very useful; we can reuse inlists for particular purposes
      and even share them between projects.
    </p>
    <p class="card-text">
      Again, the copying is necessary since if we did nothing else,
      <code>inlist</code> would still point to
      <code>inlist_wd_nova_burst_header</code> for all namelists until
      <code>rn</code> overwrote it or we did it by hand.
    </p>
  </div>
</div>

<p class='lead bg-secondary p-2'>
  <span class='text-primary font-weight-bold'>Challenge 2.2:</span>
  <strong class="font-weight-bold">Resume</strong> your run by restarting from
  the most recent photo. Do <strong class="font-weight-bold">not</strong> start
  from the beginning with the <code>rn</code> script.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-2p2" aria-expanded="true" aria-controls="sol-2p2">
      Show Solution 2.2
    </button>
  </div>
  <div class="card-body collapse" id="sol-2p2">
    <p class="card-text">
      Simply execute <kbd>./re</kbd>. When called without an explicit photo, it
      will default to using the most recent photo.
    </p>
    <p>
      You can also provide a specific
      photo corresponding to one found in the <code>photos</code> directory, as
      in <kbd>./re x150</kbd>, which would restart from the last saved photo
      from a model number ending in 150.
    </p>
  </div>
</div>
<p>
  If all is working properly, you should see something like the dashboard shown
  below:
</p>

<figure class='figure'>
  <img class="figure-img img-fluid rounded" alt='pgstar grid' src="images/pgstar_2p2.png">
  <figcaption class="figure-caption text-left">
    The <samp>pgstar</samp> grid that should open up after pointing to the
    provided version of <code>inlist_pgstar</code>.
  </figcaption>
</figure>

<div class="card border-secondary mb-3">
  <div class="card-header bg-secondary">
    <h5>Pro Tip: Edit <code>inlist_pgstar</code> on the fly</h5>
  </div>
  <div class="card-body">
    <p class="card-text">
      Unlike the other namelists, <code>&pgstar</code> can be edited and saved
      during a live run, and changes will [usually] take effect on the next
      timestep. Assuming you don't mind your computer chugging on this
      simulation, you can leave it running for the rest of this minilab. If you
      make a bad change that causes the run to crash, just restart from a photo
      again.
    </p>
  </div>
</div>

<p>
  Go ahead and look inside <code>inlist_pgstar</code> now and see if you can
  understand how this works. Note that all three plots in the profile panels
  are "special" profile plots (abundance, power, and mixing). The middle tall
  plot is a panel of history plots, though at present, it contains only one
  plot showing the evolution of central temperature and density with respect to
  the model number. The bottom shows a text summary with some entries left
  blank, and then along the left are the more familiar HR diagram and
  temperature-density profile.
</p>

<h3 class="mt-4" id="part2c">Updating the Dashboard</h3>
<p>
  Our primary goals will be to
</p>
<ul>
  <li>add a little more information to the text summary</li>
  <li>expand the history panel to three stacked panels showing more useful information</li>
</ul>
<p>
  Let's start by adding information to the text summary, which is a little
  more straightforward. Text summary fields can be any value that can be
  included in a history file, so you can find the options in <code>$MESA_DIR/star/defaults/history_columns.list</code>.
</p>
<div class="bg-secondary px-2 pt-1 mb-1">
  <p class='lead'>
    <span class='text-primary font-weight-bold'>Challenge 2.3:</span>
    Add the following to the text summary in the specified columns, below any
    existing entries:
  </p>
  <ul class='lead'>
    <li>Column 2</li>
    <ul>
      <li>Mass of the hydrogen-rich layer</li>
      <li>Mass of the helium-rich layer</li>
    </ul>
    <li>Column 4</li>
    <ul>
      <li>log of the total luminosity from nuclear reactions</li>
      <li>log of the neutrino luminosity</li>
      <li>log of the luminosity from hydrogen-burning reactions</li>
      <li>log of the luminosity from helium-burning reactions</li>
      <li>log of the luminosity from other nuclear reactions besides H and He</li>
    </ul>
  </ul>
  <p class="lead pb-2">
    Save your results and confirm that the changes are live on your dashboard.
  </p>
</div>
<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-2p3" aria-expanded="true" aria-controls="sol-2p3">
      Show Solution 2.3
    </button>
  </div>
  <div class="card-body collapse" id="sol-2p3">
    <p class="card-text">
      Edit the following lines in <code>inlist_pgstar</code>:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'star_mass'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_abs_mdot'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'he_core_mass'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'co_core_mass'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">

  </span><span class="c1">! several lines skipped</span><span class="w">

  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'num_zones'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'num_retries'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span></code></pre></figure>
    <p class='card-text'>
      to the following:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'star_mass'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_abs_mdot'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'he_core_mass'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'co_core_mass'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'h_rich_layer_mass'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'he_rich_layer_mass'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">

  </span><span class="c1">! several lines skipped</span><span class="w">

  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_Lnuc'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_Lneu'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_LH'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_LHe'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_LZ'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'num_zones'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'num_retries'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span></code></pre></figure>
    <p class="card-text">
      Each of these new entries can be found in <code>history_columns.list</code>.
      Even if they are commented out there, they can be displayed in a text
      summary.
    </p>
  </div>
</div>

<p>
  And now, let's turn our attention to the history panels, which we will expand
  to a stack of three plots showing quantities of interest.
</p>

<div class="bg-secondary px-2 pt-1 mb-1">
  <p class='lead'>
    <span class='text-primary font-weight-bold'>Challenge 2.4:</span>
    Update the history panels to have three plots. All quantities should be
    plotted against the star age with a maximum width of 30 years. From top
    to bottom, the plots should show:
  </p>
  <ul class='lead'>
    <li>
      log of the photospheric luminosity (left) and log of the hydrogen-burning luminosity (right)
    </li>
    <li>
      log of the effective temperature (left) and log of the radius (right)
    </li>
    <li>
      log of the ratio of the photospheric luminosity to the Eddington
      luminosity (left) and log of the absolute value of the rate of change of
      the star's mass
    </li>
  </ul>
  <p class="lead">
    Save your results and confirm that the changes are live on your dashboard.
  </p>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-2p4a" aria-expanded="true" aria-controls="hint-2p4a">
      Show Hint 2.4a: Resetting the Panels
    </button>
  </div>
  <div class="card-body collapse" id="hint-2p4a">
    <p class='card-text'>
      We are editing settings for the <code>History_Panels1</code> plot. Find
      these in <code>inlist_pgstar</code>. You'll find three collections
      of settings that reset the values of each panel to defaults and set the
      <var>x</var>-axis to be star age.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-2p4b" aria-expanded="true" aria-controls="hint-2p4b">
      Show Hint 2.4b: Getting Three Panels
    </button>
  </div>
  <div class="card-body collapse" id="hint-2p4b">
    <p class='card-text'>
      The control <code>History_Panels1_num_panels</code> sets the number of
      panels in this plot. Set this to 3 to display three plots.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-2p4c" aria-expanded="true" aria-controls="hint-2p4c">
      Show Hint 2.4c: Selecting Data to Plot
    </button>
  </div>
  <div class="card-body collapse" id="hint-2p4c">
    <p class='card-text'>
      To set the main (left axis) data to plot, you need to set
      <code>History_Panels_1_yaxis_name(n)</code> to some string corresponding
      to a history column. Here, <var>n</var> is some integer from 1 up to the
      number of panels.
    </p>
    <p class="card-text">
      To set the other (right axis) data to plot, you need to set
      <code>History_Panels_1_other_yaxis_name(n)</code> (for some integer
      <var>n</var>) to another string
      corresponding to a history column.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-2p4d" aria-expanded="true" aria-controls="hint-2p4d">
      Show Hint 2.4d: History Plots and History Output
    </button>
  </div>
  <div class="card-body collapse" id="hint-2p4d">
    <p class='card-text'>
      At least one of these outputs is not currently output to
      <code>history.data</code>. Unlike text summaries, data for history plots
      <em>must</em> be available in <code>history.data</code> because past data
      only exists in this file for plotting.
    </p>
    <p class="card-text">
      As a result, you will need to uncomment this in
      <code>history_columns.list</code>. Furthermore, you will need to delete (or at
      least rename) your current <code>history.data</code> file since
      <samp>MESA</samp> will not be able to write to the file with a new column
      inserted in the middle. After you've done this, you can restart from the
      most recent photo again with <kbd>./re</kbd>.
    </p>
  </div>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-2p4" aria-expanded="true" aria-controls="sol-2p4">
      Show Solution 2.4
    </button>
  </div>
  <div class="card-body collapse" id="sol-2p4">
    <p class="card-text">
      The <code>History_Panels1</code> section of <code>inlist_pgstar</code>
      should have the following:
    </p>
    <h4><samp>inlist_pgstar</samp> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="c1">!!!!!!!!!!!!!!!!!!!!!!!!</span><span class="w">
  </span><span class="c1">! History Panels 1</span><span class="w">

  </span><span class="n">History_Panels1_win_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.false.</span><span class="w">

  </span><span class="n">History_Panels1_win_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w">
  </span><span class="n">History_Panels1_win_aspect_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="w"> </span><span class="c1">! aspect_ratio = height/width</span><span class="w">

  </span><span class="n">History_Panels1_title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'History Panels'</span><span class="w">
  </span><span class="n">History_Panels1_xleft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.15</span><span class="w">
  </span><span class="n">History_Panels1_xright</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.85</span><span class="w">
  </span><span class="n">History_Panels1_ybot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.15</span><span class="w">
  </span><span class="n">History_Panels1_ytop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.85</span><span class="w">
  </span><span class="n">History_Panels1_txt_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w">

  </span><span class="c1">! setup default</span><span class="w">
  </span><span class="n">History_Panels1_num_panels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w">

  </span><span class="n">History_Panels1_xaxis_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'star_age'</span><span class="w">
  </span><span class="n">History_Panels1_xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-101d0</span><span class="w">
  </span><span class="n">History_Panels1_xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-101d0</span><span class="w">
  </span><span class="n">History_Panels1_max_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="w">
  </span><span class="n">History_Panels1_dxmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w">
  </span><span class="n">History_Panels1_xaxis_reversed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.false.</span><span class="w">
  </span><span class="n">History_Panels1_xaxis_log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.false.</span><span class="w"> </span><span class="c1">! show log10 of abs value</span><span class="w">
  </span><span class="n">History_Panels1_xmargin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">

  </span><span class="n">History_Panels1_yaxis_name</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">History_Panels1_yaxis_reversed</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.false.</span><span class="w">
  </span><span class="n">History_Panels1_yaxis_log</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.false.</span><span class="w"> </span><span class="c1">! show log10 of abs value</span><span class="w">
  </span><span class="n">History_Panels1_ymin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-101d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_ymax</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-101d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_ymargin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="w">
  </span><span class="n">History_Panels1_dymin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w">

  </span><span class="n">History_Panels1_other_yaxis_name</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w">
  </span><span class="n">History_Panels1_other_yaxis_reversed</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.false.</span><span class="w">
  </span><span class="n">History_Panels1_other_yaxis_log</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.false.</span><span class="w"> </span><span class="c1">! show log10 of abs value</span><span class="w">
  </span><span class="n">History_Panels1_other_ymin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-101d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_other_ymax</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-101d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_other_ymargin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="w">
  </span><span class="n">History_Panels1_other_dymin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w">

  </span><span class="n">History_Panels1_yaxis_name</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_L'</span><span class="w">
  </span><span class="n">History_Panels1_other_yaxis_name</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_LH'</span><span class="w">
  </span><span class="n">History_Panels1_yaxis_name</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_Teff'</span><span class="w">
  </span><span class="n">History_Panels1_other_yaxis_name</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_R'</span><span class="w">
  </span><span class="n">History_Panels1_yaxis_name</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_L_div_Ledd'</span><span class="w">
  </span><span class="n">History_Panels1_other_yaxis_name</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'log_abs_mdot'</span></code></pre></figure>
    <p class="card-text">
      Notably, the <code>History_Panels1_num_panels</code> was set to 3,
      the three groups below it were uncommented, the value of
      <code>History_Panels1_max_width</code> was set to 30 (instead of 2).
      Finally, the six axes were set by setting various elements of
      <code>History_Panels1_yaxis_name</code> and
      <code>History_Panels1_other_yaxis_name</code>.
    </p>
    
    <p class="card-text">
      You may also have chosen to use <code>photosphere_L</code> instead of <code>log_L</code> for the first panel. In that case, you would also need to set <code>History_Panels1_yaxis_log(1) = .true.</code>. If you went that route, then you would also need to uncommment the appropriate line in <code>history_columns.list</code>, as indicated below.
    </p>

    <p class="card-text">
      To get the <code>log_L_div_Ledd</code> panel to play nicely, we also had
      to uncomment that column in <code>history_columns.list</code>:
    </p>

    <h4><samp>history_columns.list</samp> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">log_g</span><span class="w"> </span><span class="c1">! log10 gravity</span><span class="w">
  </span><span class="c1">!gravity</span><span class="w">
  </span><span class="c1">!log_Ledd</span><span class="w">
  </span><span class="n">log_L_div_Ledd</span><span class="w"> </span><span class="c1">! log10(L/Leddington)</span><span class="w">
  </span><span class="c1">!lum_div_Ledd</span><span class="w">
  </span><span class="c1">!log_surf_optical_depth</span><span class="w">
  </span><span class="c1">!surface_optical_depth</span></code></pre></figure>
    <p class="card-text">
      After doing this, you'll need to stop your run (<kbd>CTRL-C</kbd>), delete
      your current <code>history.data</code> (<kbd>rm LOGS/history.data</kbd>),
      and then restart from a photo (<kbd>./re</kbd>) for that change to take
      effect. Read Hint 2.4d for a more detailed discussion of this.
    </p>
  </div>
</div>

<p>
  This is looking better, but chances are that most of your history panels are really ragged, even though the model is not changing a whole lot. Perhaps this raggedness is actually an issue, depending on how resolved you need the simulation to be, but for our purposes, we should not be this zoomed in. We'll zoom out to more reasonable limits on the <var>y</var>-axis now.
</p>

<div class="bg-secondary px-2 pt-1 mb-1">
  <p class='lead'>
    <span class='text-primary font-weight-bold'>Challenge 2.5:</span>
    Update the history panels to have the following limits on their
    <var>y</var>-axes:
  </p>
  <ul class='lead'>
    <li>
      log of the photospheric luminosity: 2.0 to 6.0
    </li>
    <li>
      log of hydrogen-burning luminosity: 2.0 to 6.0
    </li>
    <li>
      log of the effective temperature: 5.0 to 6.0
    </li>
    <li>
      log of the radius: –2.5 to 1.0
    </li>
    <li>
      log of the ratio of the photospheric luminosity to the Eddington
      luminosity: –3.0 to 1.0
    </li>
    <li>
      log of the absolute value of the rate of change of
      the star's mass: –7.0 to –4.0
    </li>
  </ul>
  <p class="lead">
    Save your results and confirm that the changes are live on your dashboard.
  </p>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-2p5" aria-expanded="true" aria-controls="sol-2p5">
      Show Solution 2.5
    </button>
  </div>
  <div class="card-body collapse" id="sol-2p5">
    <p class="card-text">
      The <code>History_Panels1</code> section of <code>inlist_pgstar</code>
      should now include the following (in addition to what was there before):
    </p>
    <h4><samp>inlist_pgstar</samp> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">History_Panels1_ymin</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_ymax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_other_ymin</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_other_ymax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_ymin</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_ymax</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_other_ymin</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.5d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_other_ymax</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_ymin</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_ymax</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_other_ymin</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-7.0d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span><span class="w">
  </span><span class="n">History_Panels1_other_ymax</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-4.0d0</span><span class="w"> </span><span class="c1">! only used if /= -101d0</span></code></pre></figure>
    <p class="card-text">
      After making these changes, you should see that all the lines in the
      history panel should be much more horizontal.
    </p>
  </div>
</div>

<h3 class="mt-4" id="part2d"><strong>Bonus:</strong> Adding an Extra History Column</h3>
<p>
  Suppose you also wanted to track the mass fractions of hydrogen and helium at
  the point of peak nuclear energy generation. You can look for a column like
  this in <code>history_columns.list</code>, but no such column exists. We will have
  to add some of our own code to accomplish this. Here's a quick summary of how
  this is done inside <code>src/run_star_extras.f90</code>:
</p>
<ol>
  <li>
    Change the return value of the <code>how_many_extra_history_columns</code>
    function to the number of extra columns you want to add.
  </li>
  <li>
    For each new column, set the name of that column by setting the appropriate
    element of <code>names</code> in the subroutine <code>data_for_extra_history_columns</code>.
  </li>
  <li>
    For each new column, set the value of that column by setting the appropriate
    element of <code>vals</code> in the subroutine <code>data_for_extra_history_columns</code>.
  </li>
  <li>
    <em>Optional:</em> Use this new history column like any other in
    <samp>pgstar</samp> and/or in working with <samp>history.data</samp>.
  </li>
</ol>

<p>
  In step 3, you will likely need to use the <span class="font-weight-bold">star
  info structure</span>, which is usually represented with the letter
  <code>s</code>. You can use this to get at data stored in the stellar model.
  For instance, <code>s% m</code> yields an
  <span class="font-weight-bold">array</span> of the mass coordinates of the
  star, and <code>s% nz</code> gives the [scalar] total number of zones in the
  model. Most useful members of the star info structure are defined in
  <code>$MESA_DIR/star_data/public</code>, particularly in
  <code>star_data_step_input.inc</code> and
  <code>star_data_step_work.inc</code>.
</p>

<div class="bg-secondary px-2 pt-1 mb-1">
  <p class='lead'>
    <span class='text-primary font-weight-bold'>Challenge 2.6:</span>
    Edit <code>src/run_star_extras.f90</code> to add two new history columns:
  </p>
  <ul class='lead'>
    <li>
      <code>max_eps_nuc_X</code>: hydrogen mass fraction (X) at the point of
      peak nuclear burning
    </li>
    <li>
      <code>max_eps_nuc_Y</code>: helium mass fraction (Y) at the point of peak
      nuclear burning
    </li>
  </ul>
  <p class="lead pb-2">
    Note that you will have to stop your run and recompile before these changes
    can take effect. You should also delete your <code>history.data</code> file
    so the new columns can be properly added.
  </p>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-2p6a" aria-expanded="true" aria-controls="hint-2p6a">
      Show Hint 2.6a: Updating the Number of Extra Columns
    </button>
  </div>
  <div class="card-body collapse" id="hint-2p6a">
    <p class='card-text'>
      First, you need to tell <samp>MESA</samp> that you want to create two
      columns. Do this by editing <code>how_many_extra_history_columns</code>
      to:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">how_many_extra_history_columns</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
     </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
     </span><span class="kt">integer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
     </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">
     </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
     </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">
     </span><span class="n">how_many_extra_history_columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w">
  </span><span class="k">end</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">how_many_extra_history_columns</span></code></pre></figure>
    <p class="card-text">
      Note in particular the second-to-last line, which has a 2 where there was
      originally a zero.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-2p6b" aria-expanded="true" aria-controls="hint-2p6b">
      Show Hint 2.6b: Setting the Column Names
    </button>
  </div>
  <div class="card-body collapse" id="hint-2p6b">
    <p class='card-text'>
      To make the first extra column, you'll need the line <code>names(1) = 'max_eps_nuc_X'</code> inside <code>data_for_extra_history_columns</code>.
      You'll need something similar for the second column, but with a different
      index and title.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-2p6c" aria-expanded="true" aria-controls="hint-2p6c">
      Show Hint 2.6c: Useful Star Info Structure Members
    </button>
  </div>
  <div class="card-body collapse" id="hint-2p6c">
    <p class='card-text'>
      While you can do this several ways, the simplest involves only three
      members of the star info structure: <code>eps_nuc</code>, <code>X</code>,
      and <code>Y</code>.
    </p>

    <p class="card-text">
      If you find you need to loop over each cell, always set up your loop to
      go from 1 up to <code>s% nz</code>, rather than iterating over all the
      elements in an array. This is because arrays in <samp>MESA</samp> are
      not always resized, and may contain data beyond the current "last cell".
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-2p6d" aria-expanded="true" aria-controls="hint-2p6d">
      Show Hint 2.6d: Finding the Location of a Maximum
    </button>
  </div>
  <div class="card-body collapse" id="hint-2p6d">
    <p class='card-text'>
      The trickiest part of computing the values for the columns is finding the
      location of the maximum nuclear energy generation rate. Assuming you have
      an array of these values, you <em>could</em> loop over these, keeping
      track of the largest value you've found. Then you would update
      <code>vals(1)</code> and <code>vals(2)</code> whenever
      you come across a larger value.
    </p>
    <p class="card-text">
      But there's an easier way! Fortran provides a function that gives the
      location of a maximum value of an array, which is called
      <code>MAXLOC</code>. The one wrinkle is that if all you do is give
      <code>MAXLOC</code> a one-dimensional array, it gives back a
      one-dimensional array with only one element rather than a scalar. You can
      get around this by using the second optional argument, which is the
      dimension along which to find maxima, which in this case would be the
      first (and only) dimension, so something like
      <code>MAXLOC(arr_of_eps_nuc, 1)</code> would give you the index where
      <code>arr_of_eps_nuc</code> is at a maximum.
    </p>
  </div>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-2p6" aria-expanded="true" aria-controls="sol-2p6">
      Show Solution 2.6
    </button>
  </div>
  <div class="card-body collapse" id="sol-2p6">
    <p class="card-text">
      First we have to set the number of new columns:
    </p>
    <h4><samp>src/run_star_extras.f90</samp> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">how_many_extra_history_columns</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
     </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
     </span><span class="kt">integer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
     </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">
     </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
     </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">
     </span><span class="n">how_many_extra_history_columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w">
  </span><span class="k">end</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">how_many_extra_history_columns</span></code></pre></figure>
    <p class="card-text">
      Then we need to set the names and values for the two new columns:
    </p>
    <h4><samp>src/run_star_extras.f90</samp> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="k">subroutine</span><span class="w"> </span><span class="n">data_for_extra_history_columns</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">names</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
     </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
     </span><span class="kt">character</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen_history_column_name</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">names</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w">
     </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">vals</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w">
     </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
     </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">
     </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
     </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">
     </span><span class="n">names</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'max_eps_nuc_X'</span><span class="w">
     </span><span class="n">names</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'max_eps_nuc_Y'</span><span class="w">
     </span><span class="n">vals</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="nb">MAXLOC</span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">eps_nuc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w">
     </span><span class="n">vals</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="nb">MAXLOC</span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">eps_nuc</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w">
  </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">data_for_extra_history_columns</span></code></pre></figure>
    <p class="card-text">
      Alternatively, we could also use the loop strategy mentioned in hint 2.6d.
      In this case, we need to define a real-valued variable to hold on to the
      maximum value of the nuclear energy generation rate (we'll call it
      <code>max_eps_nuc</code>), and we also will need an integer to hold on
      to the current cell number, which we'll call <code>k</code>. We define
      both of these in the fourth and fifth lines below, and then use them
      both in the loop over zones.
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="k">subroutine</span><span class="w"> </span><span class="n">data_for_extra_history_columns</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">names</span><span class="p">,</span><span class="w"> </span><span class="n">vals</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
     </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w">
     </span><span class="kt">character</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen_history_column_name</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">names</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w">
     </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">vals</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">max_eps_nuc</span><span class="w">
     </span><span class="kt">integer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">k</span><span class="w">
     </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
     </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">
     </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
     </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">
     </span><span class="n">names</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'max_eps_nuc_X'</span><span class="w">
     </span><span class="n">names</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'max_eps_nuc_Y'</span><span class="w">
     </span><span class="c1">! initialize the maximum to something non-sensical so it will be</span><span class="w">
     </span><span class="c1">! overwritten on the first iteration</span><span class="w">
     </span><span class="n">max_eps_nuc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w">
     </span><span class="k">do</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">nz</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">eps_nuc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_eps_nuc</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
           </span><span class="n">max_eps_nuc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">eps_nuc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w">
           </span><span class="n">vals</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w">
           </span><span class="n">vals</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w">
        </span><span class="k">endif</span><span class="w">
     </span><span class="k">enddo</span><span class="w">
  </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">data_for_extra_history_columns</span></code></pre></figure>
    <p class="card-text">
      Either way, we still need to compile with <kbd>./mk</kbd>, then we delete
      the old history data with <kbd>rm LOGS/history.data</kbd>, and finally
      restart the run with <kbd>./re</kbd>.
    </p>
  </div>
</div>

<p>
  After restarting, you should see the new columns populating at the end of your
  <code>history.data</code> file. Now we can also use these in
  <samp>pgstar</samp>.
</p>

<p class='lead bg-secondary p-2'>
  <span class='text-primary font-weight-bold'>Challenge 2.7:</span>
  Fill in the last two entries of the second column of the text summary with
  the two new columns you just implemented. Confirm that they appear in your
  pgstar dashboard.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-2p7" aria-expanded="true" aria-controls="sol-2p7">
      Show Solution 2.7
    </button>
  </div>
  <div class="card-body collapse" id="sol-2p7">
    <p class="card-text">
      The following two lines should be added/edited in
      <code>inlist_pgstar</code>.
    </p>
    <h4><samp>inlist_pgstar</samp> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'max_eps_nuc_X'</span><span class="w">
  </span><span class="n">Text_Summary1_name</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'max_eps_nuc_Y'</span></code></pre></figure>
    <p class="card-text">
      While they vary from step to step, you should find that the hydrogen
      mass fraction is around 0.2 while the helium mass fraction hovers a bit
      below 0.8.
    </p>
  </div>
</div>
<p>
  When all is said and done, your <samp>pgstar</samp> dashboard should look
  quite similar to the one below.
</p>
<div class='text-center'>
<figure class='figure'>
  <img class="figure-img img-fluid rounded" alt='pgstar dashboard' src="images/pgstar_2p7.png">
  <figcaption class="figure-caption text-left">Final pgstar dashboard including data from custom history columns.</figcaption>
</figure>
</div>

<h3 id='part2e' class="mt-4">Conclusion</h3>
<p>
  Again, we will use this work directory for the maxilab, though the columns you may or may not have added in the previous section are not absolutely necessary, so don't worry if you didn't get to that. If you were stuck on something or just need to jump ahead to get to the maxilab, grab a completed directory with the download below.
</p>
<div class="text-center mb-2">
  <a href="downloads/wolf_2.zip" download>
    <button class='btn btn-lg btn-info'>Download Completed Project</button>
  </a>
</div>


<h2 id="part3" class="mt-5">Maxilab: Finding the Stability Boundary</h2>

<p>
  We've seen that at sufficiently high accretion rates, a white dwarf can
  burn hydrogen-rich material at the same rate it is accreted, creating a stably
  and steadily burning model. These are observed as persistent supersoft sources
  (SSSs), since they are strong sources of supersoft X-rays.
</p>

<p>
  Below some particular accretion rate, which we will call the <span class="font-weight-bold">stability boundary</span>, the nuclear fusion becomes
  thermally unstable, and goes through a cycle of accretion and thermonuclear
  flashes known as <span class="font-weight-bold">recurrent novae</span>.
  Below, a <samp>pgstar</samp> video shows a couple of recurrent novae resulting
  from lowering the accretion rate to 2.0 × 10<sup>–7</sup>
  M<sub>&#8857;</sub>/yr.
</p>

<div align="center" class='embed-responsive embed-responsive-16by9'>
  <video controls fullscreen>
    <source src="videos/rne.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
</div>
<p>
  Note how the model traces out a "swoosh" in the HR diagram, and there are two
  distinct bursts in the history panels, separated by about 25.5 years. We call
  this the <span class="font-weight-bold">recurrence time</span> of the nova.
  Note also that we can see a time after the mass loss has ended that the
  luminosity and effective temperature are quite high. This is the supersoft
  source phase. It's harder to read off of the plots but it lasts from model 626 until the end (for the second burst), for duration of about 0.67 years.
</p>

<p>
  Compare that with the behavior of the model you should have constructed in
  the previous two minilabs, run for roughly the same duration:
</p>

<div align="center" class='embed-responsive embed-responsive-16by9'>
  <video controls fullscreen>
    <source src="videos/stable.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
</div>

<p>
  The model still appears to go through a "first flash" (you probably got
  through this in minilab 1), but it gets to the supersoft phase and just
  hangs there as the accreted material is consumed at the same rate it is
  accreted. Note that through many years, the H-rich layer mass is consistent at around 1.4 &#215; 10<sup>–6</sup> M<sub>&#8857;</sub>.
</p>

<p class="lead">
  Our main goal in this lab is to determine more precisely the stability
  boundary for this 1.115 M<sub>&#8857;</sub> white dwarf model.
</p>

<p>
  Additionally, you should learn the following
</p>
<ul>
  <li>how to use timestep controls to increase time resolution</li>
  <li>how to perform a basic convergence study</li>
  <li>how to change controls on the fly in <code>run_star_extras.f90</code></li>
  <li>how to use a hook to add custom physics to the model</li>
</ul>

<h3 class="mt-4" id="part3a">Updating M&#775;</h3>

<p>
  In <code>inlist_wd_nova_burst</code>, you should still have a line like

  <figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="p">&amp;</span><span class="n">controls</span><span class="w">

      </span><span class="n">mass_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.5d-7</span><span class="w">
  </span></code></pre></figure>

  We've established that at this accretion rate, the model finds a steady and stable configuration where it fuses hydrogen at the same rate it is accreted. We also showed that at only 2 &#215; 10<sup>–7</sup>, it enters a recurrent nova regime. Now we want to find the limiting accretion rate between these two regimes. We'll crowd-source random values between 2.0 &#215; 10<sup>-7</sup> M<sub>&#8857;</sub>/yr and 3.5 &#215; 10<sup>-7</sup> M<sub>&#8857;</sub>/yr. Pick yours with the tool below:
</p>
<div class='text-center'>
  <div class="btn-group btn-group-lg" role="group" aria-label="Basic example">
    <button class="btn btn-primary" type="button" id="mdot-gen">Generate My M&#775;</button>
    <button type="button" class="btn btn-secondary btn-lg" disabled>
      <span class="text-dark">
        M&#775; = <span class='mdot-base'>??? </span> &#215; 10<sup> -7 </sup> M<sub>&#8857;</sub>/yr
      </span>
    </button>
  </div>
</div>
<div class='buffer-tiny'></div>
<p class='lead bg-secondary p-2'>
  <span class='text-primary font-weight-bold'>Challenge 3.1:</span> Edit <code>inlist_wd_nova_burst</code> so that the model accretes matter at the right M&#775; you chose.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-3p1" aria-expanded="true" aria-controls="sol-3p1">
      Show Solution 3.1
    </button>
  </div>
  <div class="card-body collapse" id="sol-3p1">
    <p class="card-text">
      Change the line above in <code>inlist_wd_nova_burst</code> to <code> mass_change = <span class="mdot-base">???</span>d-7</code>
    </p>
    <p class="card-text">
      You should similarly update the following line in the
      <code>&star_job</code> namelist so that if you start the run over from
      the beginning, that the relaxation method takes the accretion rate to the
      right value:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">   </span><span class="n">relax_mass_change_final_mdot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.5d-7</span></code></pre></figure>
    <p class="card-text">
      To be clear, you should <span class="font-weight-bold">update</span> this line from <code>3.5d-7</code> to your accretion rate of <code><span class="mdot-base">???</span>d-7</code>.
    </p>
  </div>
</div>

<p>
  With your M&#775; selected, you should be able to resume your model. Restart the run with <kbd>./re</kbd>.
</p>

<div class='p-2 bg-secondary'>
  <p class="lead">
    <span class='font-weight-bold text-primary'>Challenge 3.2:</span> Restart your model, run it for at least 30 years if stable, or until it stops on its own if unstable, and report whether or not your model was stable.
  </p>
  <p class="lead">
    If it was <span class="font-weight-bold">unstable</span>, also report the following (try to get them to at least two significant digits from pgstar frames):
  </p>
  <ul class='lead'>
    <li>
      <strong>Recurrence Time:</strong> duration between successive starts of bursts
    </li>
    <li>
      <strong>SSS Duration:</strong> duration in supersoft phase where hydrogen-burning luminosity is very close to the photospheric luminosity after mass loss has ended
    </li>
  </ul>
  <p class="lead">
    If it was <span class='font-weight-bold'>stable</span>, also report the hydrogen-rich layer mass
  </p>
</div>

<div class="text-center my-4">
  <a href="https://docs.google.com/spreadsheets/d/18iE_dkCjDJO3SqNb6p-Ngrkguk5huHBGcjNFQmn0HeE/edit?usp=sharing" target=_blank>
    <button class='btn btn-lg btn-info'>Record my Data</button>
  </a>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#stability-hint" aria-expanded="true" aria-controls="stability-hint">
      Show Hint 3.2a: Determining Stability
    </button>
  </div>
  <div class="card-body collapse" id="stability-hint">
    <p class="card-text">
      Here are some example videos showing unstable and stable configurations.
      Note that these start from the very beginning of the simulation; yours
      probably started from a hot an luminous state (near the left side of the
      "knee" in the HR diagram).
    </p>
    <p class="card-text">
      Here is a movie of a model that is clearly unstable:
    </p>
    <div align="center" class='embed-responsive embed-responsive-16by9'>
      <video controls fullscreen>
        <source src="videos/rne.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    <div class='buffer-tiny'></div>
    <p class="card-text">
      And here is a movie of a model that is clearly stable:
    </p>
    <div align="center" class='embed-responsive embed-responsive-16by9'>
      <video controls fullscreen>
        <source src="videos/stable.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#timescales-hint" aria-expanded="true" aria-controls="timescales-hint">
      Show Hint 3.2b: Determining Timescales
    </button>
  </div>
  <div class="card-body collapse" id="timescales-hint">
    <p class="card-text">
      The beginnings of flashes are the easiest to identify, so estimate the time between the two subsequent sharp rises in the luminosity to get the recurrence time.
    </p>
    <p class='card-text'>
      The SSS phase duration is a little more nebulous. Estimate the the duration from the time of minimum effective temperature until the photospheric and hydrogen-burning luminosities precipitously depart from each other as they plummet. This may be too hard to do with a single pgstar frame, so consider making a movie out of your pgstar frames, and then find the frame when mass loss stops and roughly when the photospheric and nuclear luminosities begin to diverge.
    </p>
    <p class="card-text">
      The example below is taken from a simulation on a higher-mass white dwarf
      and higher accretion rate, so the timescales are much shorter. You should find recurrence times on the order of tens of years for the recurrence time and a little less than a year for the SSS phase duration.
    </p>
    <div class='text-center'>
    <figure class='figure'>
      <img class="figure-img img-fluid rounded" alt='example timescales' src="images/timescales.png">
      <figcaption class="figure-caption text-left">Example estimates for the recurrence time and SSS duration for M&#775;=3.1 &#215; 10<sup>-7</sup> M<sub>&#8857;</sub>/yr onto a 1.30 M<sub>&#8857;</sub> white dwarf. Here we estimate t<sub>recur</sub>=1.08 years and t<sub>SSS</sub>=0.26 yr.</figcaption>
    </figure>
    </div>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-3p2c" aria-expanded="true" aria-controls="hint-3p2c">
      Show Hint 3.2c: Determining H-Rich Layer Mass
    </button>
  </div>
  <div class="card-body collapse" id="hint-3p2c">
    <p class="card-text">
      This quantity should be on your pgstar dashboard. You added it to your
      panel in minilab 2 in the text summary.
    </p>
  </div>
</div>

<div class="card border-secondary mb-3">
  <div class="card-header bg-secondary">
    <h5 class='card-title mb-0'>Tool: Making Movies with <samp>images_to_movie</samp></h5>
  </div>
  <div class="card-body">
    <p class="card-text">
      Did you check out the hint about determining stability? The videos there (and earlier) were composed of all the output from pgstar. In this simulation, we output a snapshot of the pgstar output with each timestep into the <code>png</code> directory. Take a look in there, and you'll see a png for every timestep.
    </p>
    <p class='card-text'>
      To make these into a movie, the SDK comes with a nifty script that does the heavy lifting for you: <code>images_to_movie</code>. To use it, do something like the following:
    </p>
    <p class='card-text text-center'>
      <kbd>images_to_movie 'png/nova_grid*.png' my_movie.mp4</kbd>
    </p>
    <p class='card-text'>
      This takes all files that match the pattern <code>nova_grid_*.png</code> in the png directory and then makes a movie by using each as a frame. The resulting movie is named <code>my_movie.mp4</code>.
    </p>
    <p class='card-text'>
      You can control how often pgstar outputs pngs, what they are named, and what directory they go into in the pgstar namelist.
    </p>
    <div class="card border-warning mb-2">
      <div class="card-header bg-warning text-white">
        <h5 class='card-title mb-0'>Warning: Stale png Directory</h5>
      </div>
      <div class="card-body text-warning">
        <p class="card-text">
          Before you start a new run, delete all files in <code>png</code> (<kbd>rm -f png/*.png</kbd>) or rename/move them. If you don't do this, you might end up with a mix of old and new files, and you won't know which is which.
        </p>
      </div>
    </div>
  </div>
</div>

<h4 id='part3b' class='mt-4'>Resolving the SSS Phase</h4>
<p>
  This simulation is tuned to run quickly, and as a result, the supersoft phase doesn't last many timesteps. If we ran through it too quickly, we might actually have missed stability, while shorter timesteps might catch it. Our goal now is to modify our simulation so that it takes shorter time steps, but only during the SSS phase.
</p>
<p>
  Fortunately, <samp>MESA</samp> has just the controls we want: <code>delta_HR_limit</code> and <code>delta_HR_hard_limit</code>. Both of these adjust the timestep based on how much the quantity
  \[\eta = \sqrt{\left[\log (L/L_\odot)\right]^2 + \left[\log T_{\mathrm{eff}}\right]^2}\]
  changes over the timestep. If &#951; is greater than <code>delta_HR_limit</code>, then the next timestep will be reduced by a factor of <code>delta_HR_limit</code>/&#951;. If instead &#951; is greater than <code>delta_HR_hard_limit</code>, the <em>current</em> timestep will be retried with a shorter timestep.
</p>
<p>
  We could put these in our inlist, but they will make the <em>entire</em> run intolerably slow. We only want really high time resolution during the SSS phase, so we will implement this in <code>run_star_extras.f90</code>, specifically, in <code>extras_check_model</code>, which is executed at the end of every timestep. We want to use these tight tolerances only when the hydrogen burning luminosity is similar to the photospheric luminosity. We also only really care when the effective temperature is large.
</p>
<div class="card border-secondary mb-3">
  <div class="card-header bg-secondary">
      <h5 class='card-title mb-0'>Accessing the star info structure</h5>
  </div>
  <div class="card-body">
    <p class='card-text'>
      Within subroutines in <code>run_star_extras</code>, we can access the full data in the stellar model via the "star info structure", which is usually denoted as <code>s</code>. All the data you can access are listed in various files in <code>$MESA_DIR/star_data/public</code>. The two most useful files there are <code>star_data_step_input.inc</code> and <code>star_data_step_work.inc</code>. Additionally, inlist controls are members of the star info structure, so all controls in <code>$MESA_DIR/star/defaults/controls.defaults</code> can be accessed and changed.
    </p>
    <p class='card-text'>
      Depending on when in the timestep you access the star info structure, some values will have already been set and/or any changes you make might be overwritten by another internal subroutine. Understanding what is set when and how often boils down to grepping around in <code>$MESA_DIR/star/private</code>. In <code>extras_check_model</code>, everything should already be set, so we don't yet need to worry about this detail (but anything we change won't affect this timestep!).
    </p>
    <p class='card-text'>
      To access a member of the star info structure, we just append a <code>%</code> after <code>s</code>, followed by the name. For instance, <code>s% mstar</code> will return the baryonic mass of the stellar model in grams. Note that units in the star info structure are <em>usually</em> in cgs (unless otherwise indicated in the source file), while inlist controls are often given in solar units, so you may need to juggle conversions between the two.
    </p>
  </div>
</div>

<p class='lead bg-secondary p-2'>
  <span class='font-weight-bold text-primary'>Challenge 3.3:</span> Edit <code>extras_check_model</code> to add a conditional that sets <code>delta_HR_limit</code> to <code>5d-3</code> and <code>delta_HR_hard_limit</code> to <code>1d-2</code> whenever L<sub>H</sub>/L<sub>phot</sub> &lt; 1.1 <em>and</em> T<sub>eff</sub> &gt; 500,000 K <em>and</em> when L<sub>phot</sub> is above the burst threshold set by <code>L_burst</code>. Otherwise both controls should be set to –1.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#access-hint" aria-expanded="true" aria-controls="access-hint">
      Show Hint 3.3a: Accessing the luminosities and effective temperature
    </button>
  </div>
  <div class="card-body collapse" id="access-hint">
    <p class='card-text'>
      You will want to use the following in your conditional:
      <ul>
        <li>
          <code>s% power_h_burn</code>: total power in L<sub>&#8857;</sub> produced by hydrogen burning
        </li>
        <li>
          <code>s% L_phot</code>: photospheric luminosity in L<sub>&#8857;</sub>
        </li>
        <li>
          <code>s% Teff</code>: effective temperature in Kelvin
        </li>
      </ul>
      Note that the <code>s%</code> means we are talking to the object that contains all the data about the stellar model, including physical quantities <em>and</em> inlist controls.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#setting-hint" aria-expanded="true" aria-controls="setting-hint">
      Show Hint 3.3b: Setting Parameters on the Fly
    </button>
  </div>
  <div class="card-body collapse" id="setting-hint">
    <p class='card-text'>
      Use the following to set the timestep controls to the stricter limits:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">delta_HR_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5d-3</span><span class="w">
  </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">delta_HR_hard_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d-2</span></code></pre></figure>
      <p>and the looser limits:</p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">delta_HR_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w">
  </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">delta_HR_hard_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span></code></pre></figure>
  </div>
</div>
<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#resolution-sol" aria-expanded="true" aria-controls="resolution-sol">
      Show Solution 3.3
    </button>
  </div>
  <div class="card-body collapse" id="resolution-sol">
    <p class="card-text">
      The main conditional in <code>extras_check_model</code> should now be something like this:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">      </span><span class="c1">! returns either keep_going, retry, or terminate.</span><span class="w">
</span><span class="kt">integer</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">extras_check_model</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
   </span><span class="kt">integer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
   </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">
   </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
   </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">
   </span><span class="k">include</span><span class="w"> </span><span class="s1">'formats'</span><span class="w">
   </span><span class="n">extras_check_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keep_going</span><span class="w">
   </span><span class="c1">! Deactivate HR limits by default</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">delta_HR_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">delta_HR_hard_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">L_phot</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">L_burst</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">waiting_for_burst</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
         </span><span class="n">num_bursts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_bursts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="s1">'num_bursts'</span><span class="p">,</span><span class="w"> </span><span class="n">num_bursts</span><span class="w">
         </span><span class="n">waiting_for_burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.false.</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
      </span><span class="c1">! Preferentially increase time resolution based on motion through</span><span class="w">
      </span><span class="c1">! HR diagram.</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">power_h_burn</span><span class="w"> </span><span class="p">/</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">L_phot</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1.1d0</span><span class="w"> </span><span class="ow">.and.</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">Teff</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">5d5</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">delta_HR_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5d-3</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">delta_HR_hard_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d-2</span><span class="w">
      </span><span class="k">endif</span><span class="w">
   </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">L_phot</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">L_between</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_bursts</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">'have finished burst'</span><span class="w">
         </span><span class="n">extras_check_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terminate</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">termination_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_extras_check_model</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
      </span><span class="n">waiting_for_burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
   </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">extras_check_model</span></code></pre></figure>
    <p class='card-text'>
      Note that the outer conditional takes care of the luminosity condition automatically.
    </p>
  </div>
</div>

<p class='lead bg-secondary p-2'>
  <span class='font-weight-bold text-primary'>Challenge 3.4:</span> Recompile and rerun your model at the same M&#775;, but now with the increased time resolution. You can start the model from the beginning, or you can start from model 200 if the photo (<code>x200</code>) is still handy and doesn't point to model 1200. Report the same quantities as before, but now on the second column of the google spreadsheet.
</p>
<div class="text-center mb-2">
  <a href="https://docs.google.com/spreadsheets/d/18iE_dkCjDJO3SqNb6p-Ngrkguk5huHBGcjNFQmn0HeE/edit?usp=sharing" target=_blank>
    <button class='btn btn-lg btn-primary'>Record my Data (use second tab on bottom)</button>
  </a>
</div>
<h2 id='part3c' class='mt-4'>Changing the Wind Scheme</h2>
<p>
  Now that we're better resolving the SSS phase (though we have not actually verified that this is converged spatially or temporally), we now turn our attention to the effects of the mass loss mechanism. Right now, we're using the super Eddington winds, which assume that all luminosity in excess comes in the form of mass moving at the escape speed:
</p>
<p>
  $$L - L_{\rm Edd} = \frac{1}{2}\dot{M}v_{\rm esc}^2$$
</p>
<p>
  Which yields a mass loss rate of:
</p>
<p>
  $$\dot{M} = \frac{2(L-L_{\rm Edd})}{v_{\rm esc}^2}$$
</p>
<p>
  How is that <var>L</var><sub>Edd</sub> computed, though? Traditionally, it is
</p>
<p>
  $$L_{\rm Edd} = \frac{4\pi GcM}{\kappa},$$
</p>
<p>
  which is an entirely local quantity. Near the outside of the star, the mass is well-defined, but the opacity is rapidly changing. To make this even more unclear, this particular test case sets <code>tau_factor</code> to 30, which means that the outermost cell is defined to be at an optical depth 30 times greater than the photospheric optical depth of 2/3, so at an optical depth of 20.
</p>
<p>
  It turns out that, even with this definition, novae on this mass of WD are only super Eddington when their effective temperature just below the location of the bump in opacity due to iron at around log <var>T</var><sub>eff</sub> = 5.2. If the nova expands beyond this, the model would simply keep expanding. We do see novae expanding to lower effective temperatures and still losing mass, so a more accurate treatment of mass loss is likely much more involved.
</p>
<h4>Why Do We Care About This?</h4>
<p>
  If mass loss is delayed or weaker, it may be the case that the post-outburst nova enters the SSS phase with a larger hydrogen-rich envelope and is able to accrete enough during this phase to resume steady burning, whereas stronger and earlier mass loss might cause too much of a reduction in the envelope, and erroneously manifest as a recurrent novae when perhaps it should manifest as a steady burner.
</p>

<h4>How Should we "Fix" This?</h4>
<p>
  For illustrative purposes, we will make use of the control <code>super_eddington_wind_Ledd_factor</code>, which is already set to 1 in <code>inlist_wd_nova_burst</code>. As the comment indicates, this is a factor by which the Eddington luminosity is scaled by in computing the wind. We will increase this to 1.5 in the next challenge to make the winds start later and end sooner.
</p>
<p class='lead bg-secondary p-2'>
  <span class='font-weight-bold text-primary'>Challenge 3.5:</span> Increase the value of <code>super_eddington_wind_Ledd_factor</code> to 1.5. Either start your model from an early model (perhaps model 200 if photo <code>x200</code> still points to that) or start your model over from the beginning (i.e. don't restart), and observe what happens during the initial flash. Depending on your accretion rate, it may get stuck in this phase. See if you can figure out what's going on.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-3p4" aria-expanded="true" aria-controls="sol-3p4">
      Show Solution 3.5
    </button>
  </div>
  <div class="card-body collapse" id="sol-3p4">
    <p class="card-text">
      Part of your inlist should look like
    </p>
    <h4><span class="text-monospace">inlist_wd_nova_burst</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="c1">! NOTE: for super eddington wind,</span><span class="w">
</span><span class="c1">! we use Ledd averaged over mass to optical depth tau = 100</span><span class="w">
</span><span class="n">super_eddington_scaling_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
   </span><span class="c1">! parameter for mass loss driven by super Eddington luminosity</span><span class="w">
</span><span class="n">super_eddington_wind_Ledd_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5</span><span class="w">
   </span><span class="c1">! multiply Ledd by this factor when computing super Eddington wind</span><span class="w">
   </span><span class="c1">! e.g., if this is 2, then only get wind when L &gt; 2*Ledd</span></code></pre></figure>
    <p class='card-text'>
      Restart your model from an early model like 200 (<kbd>./re x200</kbd>) or from the beginning with <kbd>./rn</kbd>.
    </p>
    <h4 class='card-text'>What's Going On?</h4>
    <p class='card-text'>
      Depending on your accretion rate, you may see different outcomes, but many
      simulations will stall in the mass loss phase because the model oscillates
      wildly between accretion (mass gain) and winds (mass loss), so it cannot
      take very long timesteps.
    </p>
    <div align="center" class='embed-responsive embed-responsive-16by9'>
      <video controls fullscreen>
        <source src="videos/stable_stutter.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    <p class="card-text">
      In this video, see how the model has trouble getting through the mass loss phase? Part of this is because it is right at the cusp of triggering super Eddington winds, but the other issue is that whenever the winds cease, accretion immediately resumes (see the abundance plot for confirmation), which then affects the opacity in the outer layers, which triggers the winds, etc. In this case, we got out of it eventually, but these sorts of oscillations in behavior can spell doom for your simulation, and it's usually best to find a way to force a smoother transition.
    </p>
  </div>
</div>

<p>
  Perhaps you ran into troubles in the last challenge during the mass loss phase. If not, see the video in the solution for an example of what could happen. As discussed in the solution, issues can arise when models oscillate wildly between mass loss and mass gain. To remedy this situation, we will try to stop accretion a little before mass loss would normally begin and resume it only a little after mass loss ends.
</p>
<p>
  Perhaps we could do this by changing the <code>mass_change</code> control on
  the fly like we did with the <code>delta_HR_limit</code> controls, but a more elegant solution is to use one of <samp>MESA</samp>'s many <code>other_*</code> hooks. These "hooks" let us plug bits of physics into the evolution loop at just the right moment. In our case, we want to intervene just after any winds have been calculated, but before any mass has been added or removed from the model. The <code>other_adjust_mdot</code> hook allows for exactly this, letting us inject code at this critical time.
</p>

<p>
  The process for implementing one of these hooks is usually pretty consistent:
</p>
<ol>
  <li>Identify the hook you want to use from those available in <code>$MESA_DIR/star/other</code></li>
  <li>
    Copy and rename the "null" version of the subroutine from the proper file in <code>$MESA_DIR/star/other</code> into your <code>run_star_extras.f90</code>
  </li>
  <li>
    Point to your new subroutine in the <code>extras_controls</code> subroutine in <code>run_star_extras.f90</code>
  </li>
  <li>
    Make your <code>other_*</code> routine print something so we'll be able to see that it is being called
  </li>
  <li>
    Compile your project with <kbd>./mk</kbd>
  </li>
  <li>
    Add a line to the <code>&controls</code> namelist to tell <samp>MESA</samp> to use your routine (usually the control is something like <code>use_other_* = .true.</code>, where <code>*</code> is standing in for something more specific)
  </li>
  <li>
    Run or restart your project and ensure that the expected output is coming from the routine
  </li>
  <li>
    Stop the run, edit the routine to actually do the thing you want, recompile, and run/restart.
  </li>
</ol>
<p>
  Different hooks have different interfaces, so the above workflow may need a bit of tinkering to work right for you. We'll follow this process over the next couple of challenges for the <code>other_adjust_mdot</code> hook.
</p>

<p class='lead bg-secondary p-2'>
  <span class='font-weight-bold text-primary'>Challenge 3.6:</span> Implement the hook for <code>other_adjust_mdot</code> up to step 7 (the hook shouldn't do anything interesting, but it should print something to show it is being called). Call the subroutine <code>nova_adjust_mdot</code>.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-3p6a" aria-expanded="true" aria-controls="hint-3p6a">
      Show Hint 3.6a: The null subroutine
    </button>
  </div>
  <div class="card-body collapse" id="hint-3p6a">
    <p class="card-text">
      The following code should be copied into <code>run_star_extras.f90</code> below the <code>contains</code> statement, but outside of any other subroutine or function:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">   </span><span class="c1">! your routine will be called after winds and before mass adjustment</span><span class="w">
   </span><span class="k">subroutine</span><span class="w"> </span><span class="n">null_other_adjust_mdot</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
      </span><span class="k">use</span><span class="w"> </span><span class="n">star_def</span><span class="w">
      </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
      </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
   </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">null_other_adjust_mdot</span></code></pre></figure>
  </div>
</div>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-3p6b" aria-expanded="true" aria-controls="hint-3p6b">
      Show Hint 3.6b: Renaming the routine
    </button>
  </div>
  <div class="card-body collapse" id="hint-3p6b">
    <p class="card-text">
      Edit the <span class="font-weight-bold">two</span> lines containing the text <code>subroutine null_other_adjust_mdot</code> and edit it to <code>subroutine nova_adjust_mdot</code> to get:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">   </span><span class="c1">! your routine will be called after winds and before mass adjustment</span><span class="w">
   </span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
      </span><span class="k">use</span><span class="w"> </span><span class="n">star_def</span><span class="w">
      </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
      </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
   </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span></code></pre></figure>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-3p6c" aria-expanded="true" aria-controls="hint-3p6c">
      Show Hint 3.6c: Printing a Message
    </button>
  </div>
  <div class="card-body collapse" id="hint-3p6c">
    <p class="card-text">
      The quickest way to print something is to use something like <code>write(*,*) "MY MESSAGE HERE"</code>.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-3p6d" aria-expanded="true" aria-controls="hint-3p6d">
      Show Hint 3.6d: Activating the Hook
    </button>
  </div>
  <div class="card-body collapse" id="hint-3p6d">
    <p class="card-text">
      You'll need to add the line <code>s% other_adjust_mdot => nova_adjust_mdot</code> into
      the <code>extras_controls</code> subroutine, and then add the control <code>use_other_adjust_mdot = .true.</code> to the <code>controls namelist</code> of <code>inlist_wd_nova_burst</code>.
    </p>
  </div>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-3p6" aria-expanded="true" aria-controls="sol-3p6">
      Show Solution 3.6
    </button>
  </div>
  <div class="card-body collapse" id="sol-3p6">
    <p class="card-text">
      The following should be in <code>run_star_extras.f90</code>:
    </p>
    <h4> <span class="text-monospace">src/run_star_extras.f90</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="k">subroutine</span><span class="w"> </span><span class="n">extras_controls</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
   </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">
   </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
   </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">

   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">other_photo_read</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">extras_photo_read</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">other_photo_write</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">extras_photo_write</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">other_adjust_mdot</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">nova_adjust_mdot</span><span class="w">

   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">extras_startup</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">extras_startup</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">extras_check_model</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">extras_check_model</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">extras_finish_step</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">extras_finish_step</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">extras_after_evolve</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">extras_after_evolve</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">how_many_extra_history_columns</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">how_many_extra_history_columns</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">data_for_extra_history_columns</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">data_for_extra_history_columns</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">how_many_extra_profile_columns</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">how_many_extra_profile_columns</span><span class="w">
   </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">data_for_extra_profile_columns</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">data_for_extra_profile_columns</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">extras_controls</span><span class="w">

</span><span class="c1">! your routine will be called after winds and before mass adjustment</span><span class="w">
</span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="k">use</span><span class="w"> </span><span class="n">star_def</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
   </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">

   </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
   </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">"Hello from nova_adjust_mdot"</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span></code></pre></figure>
    <p class='card-text'>
      Note that the <code>nova_adjust_mdot</code> subroutine doesn't have to be right after <code>extras_controls</code>; it can be on its own anywhere else in the file, so long as it is below the <code>contains</code> keyword. The only difference in <code>extras_controls</code> is the line that sets <code>s% other_adjust_mdot</code>.
    </p>

    <p class="card-text">Additionally, this bit should appear in <code>inlist_wd_nova_burst</code>:</p>
    <h4> <span class="text-monospace">inlist_wd_nova_burst</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="p">&amp;</span><span class="n">controls</span><span class="w">
   </span><span class="n">use_other_adjust_mdot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span></code></pre></figure>
    <p class="card-text">
      Then we compile (which takes into account the changes in <code>run_star_extras.f90</code>) with <kbd>./mk</kbd> and restart with <kbd>./re</kbd>. You should see the message you printed in the terminal output for each step. In this case, <code>Hello from nova_adjust_mdot</code> should appear.
    </p>
  </div>
</div>

<p>
  We have successfully injected some code into our project at just the right time. Now we just need to make it useful! Look at our new <code>nova_adjust_mdot</code> subroutine. There's not much going on. Some hooks work by having you modify data on the star info structure directly. Others work by having you modify a variable with an intent of out. This one doesn't really give you much to go on, and to be honest, the comments in <code>$MESA_DIR/star/other/other_adjust_mdot.f90</code> don't really give you a whole lot to go on. So what can we do in here?
</p>

<p>
  Well, if you track down when in the flow of execution <code>s% other_adjust_mdot</code> is called in <code>$MESA_DIR/star/private</code>, you'll find it is at the time when <code>s% mstar_dot</code> has just been updated after winds. This is what we will want to [possibly] change in our routine.
</p>

<p>
  But still, we don't even have the star info structure (what we usually call <code>s</code>) set up yet! Many subroutines do this for us out of the box, so we might take it for granted. Look now at the <code>extras_startup</code> subroutine (or one or many other subroutines, actually). This code is also shown below for convenience:
</p>
<h4><span class="text-monospace">src/run_star_extras.f90</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="k">subroutine</span><span class="w"> </span><span class="n">extras_startup</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">restart</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
   </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">restart</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
   </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">             </span><span class="c1">! LOOK HERE</span><span class="w">
   </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
   </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">                 </span><span class="c1">! LOOK HERE</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">                      </span><span class="c1">! LOOK HERE</span><span class="w">
   </span><span class="k">call</span><span class="w"> </span><span class="n">test_suite_startup</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">restart</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">.not.</span><span class="w"> </span><span class="n">restart</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="n">num_bursts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
      </span><span class="n">waiting_for_burst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.true.</span><span class="w">
   </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">extras_startup</span></code></pre></figure>
<p>
  In that subroutine (and many others) there are three key lines that set up the star info structure. Early on, we instantiate a variable <code>s</code> with a type of <code>star_info</code>, then later we set it up by calling the subroutine <code>star_ptr</code>, and for good measure, we return if the previous line set <code>ierr</code> to an nonzero value (<code>ierr</code> is an integer that indicates if an error has occurred when it is nonzero). After <code>star_ptr</code> successfully exits, <code>s</code> is now set up. We can do the same thing in <code>nova_adjust_mdot</code> to set up the star info structure so we can query it for data and, crucially, update the value of <code>s% mstar_dot</code>.
</p>
<div class="bg-secondary px-2 pt-2">
  <p class='lead'>
    <span class='font-weight-bold text-primary'>Challenge 3.7:</span> Edit <code>nova_adjust_mdot</code> to set up the star info structure, and then set <code>s% mstar_dot</code> to zero if all of the conditions are met:
  </p>
  <ul class='lead'>
    <li>We are in a burst (alternatively, we are not "waiting for a burst")</li>
    <li><code>s% mstar_dot</code> is not currently negative (don't want to shut off winds)</li>
    <li>The effective temperature is less than 5 &#215; 10<sup>5</sup> K (allows accretion after mass loss is over)</li>
    <li>The model is not currently in a relaxation process (like <code>relax_initial_mass_change</code>; turns out we need this or else we'll shut off accretion even though the model thinks it is relaxing <code>mass_change</code>)</li>
  </ul>
  <p class="lead pb-2">
    Confirm your code compiles, but don't run it until verifying that it makes sense by looking at the solution.
  </p>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-3p7" aria-expanded="true" aria-controls="hint-3p7">
      Show Hint 3.7: Useful Members of the Star Info Structure
    </button>
  </div>
  <div class="card-body collapse" id="hint-3p7">
    <p class="card-text">
      You can complete this challenge using only the three following members of the star info structure:
    </p>
    <ul class='card-text'>
      <li><code>s% mstar_dot</code></li>
      <li><code>s% Teff</code></li>
      <li><code>s% doing_relax</code></li>
    </ul>
    <p class='card-text'>
      Note that the model is considered "in a burst" whenever <code>waiting_for_burst</code> is <code>.false.</code>. You might as well reuse this nifty variable in your code!
    </p>
    <p class="card-text">You might also notice that there is another member, <code>s% star_mdot</code>. Frustratingly, this is <span class="font-weight-bold">not</span> what we want to use. If you have extra time, try to figure out what the difference between <code>s% mstar_dot</code> and <code>s% star_mdot</code> by grepping around in <code>$MESA_DIR/star/private</code>.</p>
  </div>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-3p7" aria-expanded="true" aria-controls="sol-3p7">
      Show Solution 3.7
    </button>
  </div>
  <div class="card-body collapse" id="sol-3p7">
    <p class="card-text">
      Below is a working implementation. You may have come up with an equivalent solution. The <code>MIN</code> function ensures that we don't override a negative value for <code>s% mstar_dot</code>, but you could achieve the same effect with more conditionals.
    </p>
    <h4> <span class="text-monospace">src/run_star_extras.f90</span> (partial)</h4>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="c1">! your routine will be called after winds and before mass adjustment</span><span class="w">
</span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="k">use</span><span class="w"> </span><span class="n">star_def</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
   </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">

   </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
   </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">.not.</span><span class="w"> </span><span class="n">waiting_for_burst</span><span class="w"> </span><span class="ow">.and.</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">Teff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">5d5</span><span class="w"> </span><span class="ow">.and.</span><span class="w"> </span><span class="ow">.not.</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">doing_relax</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">mstar_dot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">MIN</span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">mstar_dot</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
   </span><span class="k">endif</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span></code></pre></figure>
    <p class='card-text'>
      Then confirm that it compiles with <kbd>./mk</kbd>
    </p>
  </div>
</div>

<p class='bg-secondary lead p-2'>
  <span class='font-weight-bold text-primary'>Challenge 3.8:</span> Test your model again with the functional <code>nova_adjust_mdot</code> by recompiling and then restarting before the first burst gets to mass loss. Report the same data to the appropriate place in the google sheet. Keep the new value of <code>super_eddington_wind_Ledd_factor</code> from Challenge 3.5.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-3p8" aria-expanded="true" aria-controls="hint-3p8">
      Show Hint 3.8: On Restarting
    </button>
  </div>
  <div class="card-body collapse" id="hint-3p8">
    <p class="card-text">
      Nothing should have changed for the beginning of your runs since minilab 2. You should be able to restart from several hundred steps in, so probably around photo <code>x300</code>, assuming that corresponds with model 300 and not 1300 or 2300. You can do this via <kbd>./re x300</kbd>. You can try different photos to see which start you during the thermonuclear runaway, but before the expansion and surge to the red.
    </p>
    <p class="card-text">
      If you can't find a good photo to start from, just start the model anew with <kbd>./rn</kbd>. It'll just take longer (don't worry, this is the last one).
    </p>
  </div>
</div>
<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#sol-3p8" aria-expanded="true" aria-controls="sol-3p8">
      Show Solution 3.8
    </button>
  </div>
  <div class="card-body collapse" id="sol-3p8">
    <p class="card-text">
      Here is an example of a model that was unstable in all sitautions before, but became stable with these modifications after the second burst. Note that the hiccups still occur during mass loss, but accretion doesn't resume (see the abundance plot for proof). Compare this to the video in Solution 3.5.
    </p>
    <div align="center" class='embed-responsive embed-responsive-16by9'>
      <video controls fullscreen>
        <source src="videos/with_adjust_mdot.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
  </div>
</div>

<div class="text-center mb-2">
  <a href="https://docs.google.com/spreadsheets/d/18iE_dkCjDJO3SqNb6p-Ngrkguk5huHBGcjNFQmn0HeE/edit?usp=sharing" target=_blank>
    <button class='btn btn-lg btn-primary'>Record my Data (use third tab on bottom)</button>
  </a>
</div>
<p>
  Again for your reference, a completed project is available for download below.
</p>

<div class="text-center mb-2">
  <a href="downloads/wolf_3.zip" download>
    <button class='btn btn-lg btn-info'>Download Completed Project</button>
  </a>
</div>

<h2 id="part4" class='mt-5'> Discussion</h2>
<p>
  What happened to your model as we changed the resolution and the mass loss mechanism? There are probably three options:
</p>
<ol>
  <li>It was stable and it always remained stable</li>
  <li>It was unstable and it always remained unstable</li>
  <li>The stability depended on the resolution and/or mass loss settings</li>
</ol>
<p>
  At the high and low ends of the accretion rate range, you likely were in the first or second camp, but in the middle, some interesting things happen. So what is the "real" value for the stability limit? It's hard to say from this data alone, especially since we haven't truly confirmed that we have numerically converged by increasing the time resolution even further. In the interest of time, we never even tried increasing the spatial (mesh) resolution, but that should happen as well.
</p>
<p>
  But even if this were numerically converged, our physical assumptions of mass loss can have a real effect. Perhaps the expansion of the atmosphere is strong enough to disrupt the accretion disc and the white dwarf could not resume accretion until much later, making steady burning much more difficult. Or perhaps a better model for mass loss would lose more or less of the envelope. At a certain point, you need to write the paper, in which case you should:
</p>
<ol>
  <li>Strive to make reasonable assumptions and state them clearly, along with justification and any forseeable ramifications</li>
  <li>Provide sufficient materials for others to recreate your simulation so that someone later can verify your findings and expand upon them with different assumptions</li>
</ol>
<p class='mb-5'>
  As the saying goes, <span class="font-weight-bold">"All models are wrong. Some are useful."</span>
</p>







<!--

<h1 class="display-1 my-5">Suspicious from here on out</h1>
<h2 id='part3z' class='mt-4'>A New Wind Scheme</h2>
<p>
  The super eddington wind scheme we've been using for mass loss is simple and convenient, but you may have noticed that it continues well into the supersoft phase. In fact, this is largely due to the fact that we've moved the outer boundary condition to an optical depth of 20, which has the effect of making the model think it is super-eddington.
</p>
<p>
  Let's try replacing this wind scheme with the optically-thick wind model from <a href="https://ui.adsabs.harvard.edu/abs/1994ApJ...437..802K/abstract" target=_blank>Kato & Hachisu 1994</a>. They give a relatively simple law for the mass loss rate as a function of effective temperature:
  \[\log\left(\dot{M}/\mathrm{g/s}\right) = -1.49 \log\left(T_{\mathrm{eff}}/10^5\,\mathrm{K}\right) + b\]
  where <var>b</var> is a parameter that varies with the mass of the underlying white dwarf and is given by the table
</p>
<div class='row'>
  <div class='col-4 offset-4'>
  <table class='table table-striped table-hover table-sm table-responsive'>
    <caption>
      Nova wind parameters from <a href="https://ui.adsabs.harvard.edu/abs/1994ApJ...437..802K/abstract" target=_blank>Kato & Hachisu 1994</a>
    </caption>
    <thead class='thead-dark'>
      <tr>
        <th>Mass [M<sub>&#8857;</sub>]</th>
        <th><var>b</var></th>
      </tr>
    </thead>
    <tbody>
      <tr class='text-center'>
        <td>1.33</td>
        <td>20.78</td>
      </tr>
      <tr class='text-center'>
        <td>1.20</td>
        <td>20.72</td>
      </tr>
      <tr class='text-center'>
        <td>1.10</td>
        <td>20.67</td>
      </tr>
      <tr class='text-center'>
        <td>1.00</td>
        <td>20.62</td>
      </tr>
      <tr class='text-center'>
        <td>0.90</td>
        <td>20.55</td>
      </tr>
      <tr class='text-center'>
        <td>0.80</td>
        <td>20.49</td>
      </tr>
      <tr class='text-center'>
        <td>0.70</td>
        <td>20.38</td>
      </tr>
      <tr class='text-center'>
        <td>0.60</td>
        <td>20.24</td>
      </tr>
      <tr class='text-center'>
        <td>0.50</td>
        <td>20.01</td>
      </tr>
    </tbody>
  </table>
</div>
</div>
<p>
  This wind scheme is no longer implemented in <samp>MESA</samp>, so we will
  need to implement it in <code>run_star_extras.f90</code>. To do that, we will
  use the <code>other_wind</code> hook provided by <samp>MESA</samp> to inject
  code at the moment in the evolve loop when winds are calculated. Before we do that, we'll implement a "null" subroutine that just prints a statement to the terminal to confirm that it is being called.
</p>
<div class="bg-secondary px-2 pt-2">
  <p class='lead'>
    <span class='font-weight-bold text-primary'>Challenge 3.5:</span> Implement
    and activate a "null" wind routine that just prints out something to the
    screen to let you know it ran by doing the following:
  </p>
  <ol class="lead pb-2">
    <li>Copy the subroutine <code>null_other_wind</code> from <code>$MESA_DIR/star/other/other_wind.f90</code> into <code>run_star_extras.f90</code>.</li>
    <li>Rename the subroutine to <code>nova_wind</code>.</li>
    <li>Edit the subroutine so that it prints out a message to the terminal when it is called.</li>
    <li>Set the proper pointer in <code>extras_controls</code> and the proper inlist control to activate the wind (see the contents of <code>$MESA_DIR/star/other/other_wind.f90</code> for some help) </li>
    <li>
      Compile and restart your model long enough to confirm that the message is being printed to the screen.
    </li>
  </ol>
</div>
<div class=

<p>
  Now we're ready to implement the wind scheme and try out our model. We'll need
  to add some logic to <code>nova_wind</code> and shut off the old wind scheme. The <code>nova_wind</code> subroutine (and any <code>other_wind</code> subroutine) takes the following surface quantities in as inputs from the stellar model (all in cgs units):
</p>
  <ol class=>
    <li>photospheric luminosity</li>
    <li>mass</li>
    <li>photospheric radius</li>
    <li>photospheric temperature</li>
    <li>mass fractions of hydrogen, helium, and metals</li>
  </ol>
<p>
  You'll see the corresponding variables all have an intent of "in". This tells the compiler that you don't intend to modify these variables and it will flag it if you do at compile time. There is another useful variable that has an intent of "out", which is <code>w</code>. This is the variable you need to <em>set</em> to the value of the wind, measured in M<sub>&#8857;</sub>/yr, where a postive value indicates mass loss.
</p>

<p class='lead bg-secondary p-2'>
  <span class='font-weight-bold text-primary'>Challenge 3.6:</span> Implement the nova wind scheme described above in <code>nova_wind</code>. Also edit <code>inlist_wd_nova_burst</code> to deactivate the previous wind scheme we used before.
</p>

<div class="card border-secondary mb-3">
  <div class="card-header bg-secondary">
      <h5 class='card-title mb-0'>Using Astrophysical Constants</h5>
  </div>
  <div class="card-body">
    <p class='card-text'>
      Often quantities are stored in the star info structure (or passed into <code>other_*</code> routines) in cgs, but relevant controls/outputs (and indeed some of the internal values in the star info structure) are expressed in solar units. Converting between these (and many other tasks) are made easy by the <samp>const</samp> module, which is loaded at the top of your <code>run_star_extras.f90</code> file:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">   </span><span class="k">use</span><span class="w"> </span><span class="n">star_lib</span><span class="w">
   </span><span class="k">use</span><span class="w"> </span><span class="n">star_def</span><span class="w">
   </span><span class="k">use</span><span class="w"> </span><span class="n">const_def</span><span class="w"> </span><span class="c1">! loads all sorts of goodies</span><span class="w">
   </span><span class="k">use</span><span class="w"> </span><span class="n">math_lib</span><span class="w">
   </span><span class="k">use</span><span class="w"> </span><span class="n">auto_diff</span></code></pre></figure>
    <p class='card-text'>
      Look in <code>$MESA_DIR/const/public/const_def.f90</code> to see what constants are already available. So long as the module is loaded, you don't need to declare these or anything before using them, and they aren't part of the star info structure, so you could just reference <code>Lsun</code> directly in any of the code, and it will evaluate to a solar luminosity in cgs.
    </p>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-3p6a" aria-expanded="true" aria-controls="hint-3p6a">
      Show Hint 3.6a: Deactivating the super Eddington wind
    </button>
  </div>
  <div class="card-body collapse" id="hint-3p6a">
    <p class="card-text">
      To shut off the super eddington winds, you can do one of two things to the <code>super_eddington_scaling_factor</code> control:
    </p>
    <ul>
      <li>Set it to 0 (instead of 1), which multiplies any calculated wind by 0.</li>
      <li>Comment out or delete the line. This will revert the value to its default, which is 0.</li>
    </ul>
  </div>
</div>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#hint-3p6b" aria-expanded="true" aria-controls="hint-3p6b">
      Show Hint 3.6b: Determining the value of <var>b</var>
    </button>
  </div>
  <div class="card-body collapse" id="hint-3p6b">
    <p class="card-text">
      You can hard-code in a value of <var>b</var> appropriate for our 1.10 M<sub>&#8857;</sub> white dwarf. For valuable <samp>MESA</samp> bonus points, you can have it be automatically determined from the mass parameter and interpolated reasonably.
    </p>
  </div>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#nova-wind-sol" aria-expanded="true" aria-controls="nova-wind-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="nova-wind-sol">
    <p class="card-text">
      Something like this should appear in your <code>controls</code> namelist:
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="c1">! parameter for mass loss driven by super Eddington luminosity. Final</span><span class="w">
  </span><span class="c1">! mdot is multiplied by this value, so 0 shuts wind off (default)</span><span class="w">
  </span><span class="n">super_eddington_scaling_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="c1">! multiply Ledd by this factor when computing super Eddington wind</span><span class="w">
  </span><span class="c1">! e.g., if this is 2, then only get wind when L &gt; 2*Ledd</span><span class="w">
  </span><span class="n">super_eddington_wind_Ledd_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">

  </span><span class="n">nova_scaling_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">! turn the wind on full blast</span><span class="w">
  </span><span class="n">nova_wind_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20.77</span><span class="w"> </span><span class="c1">! interpolated from table</span><span class="w">
  </span><span class="n">nova_wind_max_Teff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3d5</span><span class="w"> </span><span class="c1">! don't calculate wind if hotter than this</span><span class="w">
  </span><span class="n">nova_wind_min_L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d4</span><span class="w"> </span><span class="c1">! don't calculate wind if less luminous than this</span><span class="w">
  </span><span class="n">nova_roche_lobe_radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d2</span><span class="w"> </span><span class="c1">! at radii above this, use `nova_RLO_mdot`</span><span class="w">
  </span><span class="n">nova_RLO_mdot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1d-3</span><span class="w"> </span><span class="c1">! mdot to use if radius is larger than roche_lobe_radius</span></code></pre></figure>
    You also could just delete the two lines about the super eddington wind.
    </p>
  </div>
</div>
<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Rerun your model at the same M&#775; as the first two times. Now it should use the nova wind prescription <em>and</em> have the higher time resolution in the SSS phase. Report the same quantities as before, but now on the third tab of the google spreadsheet.
</p>
<div class="text-center mb-2">
  <a href="https://docs.google.com/spreadsheets/d/17UuB2cA5QniX65THA9VNQRNPgjXtiQTWQaO_2E0PZAQ/edit?usp=sharing" target=_blank>
    <button class='btn btn-lg btn-primary'>Record my Data (use third tab on bottom)</button>
  </a>
</div>
<h2 id='part3f' class='mt-5'>Controlling Accretion</h2>
<p>
  In both wind prescriptions, if the model wasn't losing mass, it was gaining it. In reality, a nova eruption might disrupt its accretion disk or clear out a wind from a red giant donor. More practically (and less physically motivated), sometimes switching from mass gain in one timestep to mass loss in the next can create numerical difficulties. One solution is to have a buffer time in between mass loss and gain in which no mass change takes place.
</p>
<p>
  You may have noticed the <code>nova_min_Teff_for_accretion</code> control in the last challenge. The name of this control suggests that it might be just what we want!
</p>
<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Use the <code>nova_min_Teff_for_accretion</code> control to shut off accretion when T<sub>eff</sub> &lt; 6 &#215; 10<sup>5</sup> K. Run the model and confirm that this worked by watching the history of M&#775; and T<sub>eff</sub> on the pgstar dashboard.
</p>
<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#accretion-control-sol" aria-expanded="true" aria-controls="accretion-control-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="accretion-control-sol">
    <p class="card-text">
      Something like this should appear in your <code>controls</code> namelist:
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">nova_min_Teff_for_accretion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6d5</span></code></pre></figure>
    </p>
  </div>
</div>
<p>
  Uh oh... that control didn't work, did it? The documentation in <code>$MESA_DIR/star/defaults/controls.defaults</code> tells us
  <samp>When nova_scaling_factor /= 0 and Teff < this and L > nova_wind_min_L, no accretion.</samp> That sure <em>sounds</em> right, so what's going on? Have we found a bug?
</p>
<p>
  Let's take a look at the source to see where this control actually comes in to play. Most of the good sciency bits of code are found in <code>$MESA_DIR/star/private</code>. The functions and subroutines there aren't accessible to you in <code>run_star_extras.f90</code>, but they can help you see how the sausage is made.
</p>
<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Look in <code>$MESA_DIR/star/private</code> to find where <code>nova_min_Teff_for_accretion</code> is implemented.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#grep-hint" aria-expanded="true" aria-controls="grep-hint">
     Show Hint: Searching in star/private
    </button>
  </div>
  <div class="card-body collapse" id="grep-hint">
    <p class="card-text">
      To search for "example" in all fortran (.f90) files in <code>$MESA_DIR/star/private</code>, try using <code>grep</code>:
    </p>
    <p>
      <kbd>cd $MESA_DIR/star/private</kbd><br>
      <kbd>grep "example" *.f90</kbd>
    </p>
  </div>
</div>
<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#find-implementation-sol" aria-expanded="true" aria-controls="find-implementation-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="find-implementation-sol">
    <p class="card-text">
      First, to find the relevant lines, we do <br>
      <kbd>cd $MESA_DIR/star/private</kbd><br>
      <kbd>grep "nova_min_Teff_for_accretion" *.f90</kbd>
    </p>
    <p>
      We then get the following output (in mesa revision 11701):
      <pre><code>
ctrls_io.f90:    nova_scaling_factor, nova_wind_b, nova_wind_max_Teff, nova_wind_min_L, nova_min_Teff_for_accretion,&
ctrls_io.f90: s% nova_min_Teff_for_accretion = nova_min_Teff_for_accretion
ctrls_io.f90: nova_min_Teff_for_accretion = s% nova_min_Teff_for_accretion
star_controls.inc:         real(dp) :: nova_min_Teff_for_accretion, nova_roche_lobe_radius, nova_RLO_mdot
winds.f90:         !      T1 < s% nova_min_Teff_for_accretion .and. s% mass_change > 0) then
      </code></pre>
    </p>
    <p>
      All but the last are code that just deal with defining and loading valid controls from namelists. So the implementation is in <code>winds.f90</code>. There we find that it's thrown away in a comment!
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="c1">!if (s% nova_scaling_factor /= 0 .and. L1/Lsun &gt; s% nova_wind_min_L .and. &amp;</span><span class="w">
</span><span class="c1">!      T1 &lt; s% nova_min_Teff_for_accretion .and. s% mass_change &gt; 0) then</span><span class="w">
</span><span class="c1">!   mdot = 0</span><span class="w">
</span><span class="c1">!else</span><span class="w">
  </span><span class="n">mdot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval_nova_wind</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">L1</span><span class="p">/</span><span class="n">Lsun</span><span class="p">,</span><span class="w"> </span><span class="n">R1</span><span class="p">/</span><span class="n">Rsun</span><span class="p">,</span><span class="w"> </span><span class="n">T1</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dbg</span><span class="w"> </span><span class="ow">.or.</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">report_ierr</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">'set_mdot: eval_nova_wind ierr'</span><span class="w">
     </span><span class="k">return</span><span class="w">
  </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span><span class="c1">!end if</span></code></pre></figure>
    </p>
    <p>
      Perhaps you can see the problem. If <code>T1</code> (which here is the surface temperature) is less than the paramter, it will always set the change in the star's mass to be zero. That is, not only will mass gain be turned off, but <em><strong>so is our wind</strong></em>.
    </p>
  </div>
</div>
<p>
  So it looks like the original implementation of this control didn't really work as intended. (Aside: this was discovered, and the quick fix was to deactivate the control, but then the real fix has not yet been committed). So we're going to implement it!
</p>
<p>
  To implement this control, we'll use one of <samp>MESA</samp>'s "other" hooks, prototyped in <code>$MESA_DIR/star/other</code>. These files each allow you to drop some code into your <code>run_star_extras.f90</code> that are injected into the evolution at runtime. The proper one to use here is <code>other_adjust_mdot</code>, which gives us the last word on mass gain or loss in the star (by ultimately setting <code>s% mstar_dot</code>).
</p>
<h4>Setting Up A Null Hook</h4>
<p>
  Before we implement this control, let's set up a hook into <samp>MESA</samp> that does nothing but print a statement out to the terminal so we know it's being called. Copy the <code>null_other_adjust_mdot</code> subroutine from <code>$MESA_DIR/star/other/other_adjust_mdot.f90</code> into <code>src/run_star_extras</code> in your local nova directory, right below <code>end subroutine extras_controls</code>. Rename the subroutine something more descriptive, like <code>nova_adjust_mdot</code> (be sure to update the name at the beginning and the end of the subroutine).
</p>
<p>
  Just because the subroutine is there doesn't mean it will be called when <samp>MESA</samp> is checking for the <code>other_adjust_mdot</code> hook. We need to edit <code>extras_conrols</code> to tell it that our new subroutine should be injected at that stage of evolution by adding
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">  </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">other_adjust_mdot</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">nova_adjust_mdot</span></code></pre></figure>
</p>
<p>
  The two subroutines together should now look like this:
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">      </span><span class="k">subroutine</span><span class="w"> </span><span class="n">extras_controls</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
         </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
         </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
         </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">
         </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
         </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">

         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">extras_startup</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">extras_startup</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">extras_check_model</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">extras_check_model</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">extras_finish_step</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">extras_finish_step</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">extras_after_evolve</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">extras_after_evolve</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">how_many_extra_history_columns</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">how_many_extra_history_columns</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">data_for_extra_history_columns</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">data_for_extra_history_columns</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">how_many_extra_profile_columns</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">how_many_extra_profile_columns</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">data_for_extra_profile_columns</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">data_for_extra_profile_columns</span><span class="w">

         </span><span class="c1">! YOU ADDED THIS LINE</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">other_adjust_mdot</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">nova_adjust_mdot</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">extras_controls</span><span class="w">

      </span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
         </span><span class="k">use</span><span class="w"> </span><span class="n">star_def</span><span class="w">
         </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
         </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
         </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span></code></pre></figure>
</p>
<p>
  Now let's add our write statement into <code>nova_adjust_mdot</code>, right after <code>ierr = 0</code>:
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="w">      </span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
         </span><span class="k">use</span><span class="w"> </span><span class="n">star_def</span><span class="w">
         </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
         </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
         </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">"Hello from nova_adjust_mdot!"</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span></code></pre></figure>
</p>
<p>
  Compile your code to make sure there aren't any syntax errors with <kbd>./mk</kbd>. Assuming things compiled fine, there's one last step you need to do to make <samp>MESA</samp> actually call our subroutine: add the line <code>use_other_adjust_mdot = .true.</code> to the <code>controls</code> namelist. After you've done that, run the simulation to see if your friendly message shows up at every timestep.
</p>
<figure class='figure'>
  <img src="hello_adjust.png" class='figure-img img-fluid rounded' alt='terminal output with adjust_mdot message'>
  <figcaption class='figure-caption'>
    Output with our pointless <code>other_adjust_mdot</code> properly working.
  </figcaption>
</figure>

<p>
  Now we are almost ready to do something interesting. Delete the write statement from your subroutine. We need to get access to the star info structure, which is the entity that lets us access and change physical details about the star. Each stellar model has an integer <code>id</code>. We can get the star info structure loaded by using this id, which is the main argument to our subroutine. You'll need to add two lines to your subroutine:
</p>
<ol>
  <li>
    <code>type (star_info), pointer :: s</code>: put this line before the <code>ierr = 0</code> line, since all declarations must come at the beginning of a subroutine; this line allocates space for the star info structure and names it <code>s</code>, which is a common convention throughout <samp>MESA</samp>
  </li>
  <li>
    <code>call star_ptr(id, s, ierr)</code>: this conjures up the star info structure into <code>s</code> from the <code>id</code> provided in the signature to our subroutine. Now we can use <code>s</code> as a handle into our stellar model. Put it after <code>ierr = 0</code>
  </li>
</ol>
<p>
  Double check that your code compiles. If it does, now you're ready to actually implement this control!
</p>
<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Finish the implementation of <code>nova_adjust_mdot</code>. Set <code>s% mstar_dot = 0d0</code> if <em>all</em> of the following conditions are met simultaneously:
</p>
<ul>
  <li class='lead'>
    Value set by <code>nova_scaling_factor</code> &gt; 0
  </li>
  <li class='lead'>
    Luminosity is above value set by <code>nova_wind_min_L</code>
  </li>
  <li class='lead'>
    Effective temperature is in between values set by <code>nova_wind_max_Teff</code> and <code>nova_min_Teff_for_accretion</code>
  </li>
</ul>
<p class='lead'>
  Otherwise, it should do nothing.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#star-info-members-hint" aria-expanded="true" aria-controls="star-info-members-hint">
      Show Hint: Useful Members of the Star Info Structure
    </button>
  </div>
  <div class="card-body collapse" id="star-info-members-hint">
    <p class="card-text">
      You'll want to make use of the following members of the star info structure (that are just taken from the <code>controls</code> namelist):
    </p>
    <ul>
      <li><code>nova_scaling_factor</code></li>
      <li><code>nova_nova_wind_min_L</code> (note that this is in L<sub>&#8857;</sub>)</li>
      <li><code>nova_wind_max_Teff</code></li>
      <li><code>nova_min_Teff_for_accretion</code></li>
    </ul>
    <p>
      and the following from the model's physical data (found in <code>$MESA_DIR/star/public/star_data.inc</code>):
    </p>
    <ul>
      <li><code>mstar_dot</code></li>
      <li><code>Teff</code></li>
      <li><code>L_phot</code> (fortunately, this is <em>also</em> in L<sub>&#8857;</sub>, so we don't need to convert)</li>
    </ul>
  </div>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#control-accretion-sol" aria-expanded="true" aria-controls="control-accretion-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="control-accretion-sol">
    <p class="card-text">
      Your full implementation of <code>nova_adjust_mdot</code> should look something like this:
    </p>
<figure class="highlight"><pre><code class="language-fortran" data-lang="fortran"><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="k">use</span><span class="w"> </span><span class="n">star_def</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">id</span><span class="w">
   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="k">out</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ierr</span><span class="w">
   </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">star_info</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">s</span><span class="w">

   </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
   </span><span class="k">call</span><span class="w"> </span><span class="n">star_ptr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w">
   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ierr</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w">

   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">nova_scaling_factor</span><span class="w"> </span><span class="ow">.GT.</span><span class="w"> </span><span class="mf">0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">L_phot</span><span class="w"> </span><span class="ow">.GT.</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">nova_wind_min_L</span><span class="w"> </span><span class="ow">.AND.</span><span class="w"> </span><span class="p">&amp;</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">Teff</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">nova_wind_max_Teff</span><span class="w"> </span><span class="ow">.AND.</span><span class="w"> </span><span class="p">&amp;</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">Teff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">nova_min_Teff_for_accretion</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
         </span><span class="n">s</span><span class="o">%</span><span class="w"> </span><span class="n">mstar_dot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0d0</span><span class="w">
      </span><span class="k">endif</span><span class="w">
   </span><span class="k">endif</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">subroutine</span><span class="w"> </span><span class="n">nova_adjust_mdot</span></code></pre></figure>
  </div>
</div>




<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Rerun your model at the same M&#775; as the first three times. Now it should use the nova wind prescription with the higher time resolution in the SSS phase <em>and</em> accretion should stop before mass loss begins (if it ever begins). Report the same quantities as before, but now on the fourth tab of the google spreadsheet.
</p>
<div class="text-center mb-2">
  <a href="https://docs.google.com/spreadsheets/d/17UuB2cA5QniX65THA9VNQRNPgjXtiQTWQaO_2E0PZAQ/edit?usp=sharing" target=_blank>
    <button class='btn btn-lg btn-primary'>Record my Data (use fourth tab on bottom)</button>
  </a>
</div>
<h4> Discussion </h4>
<p>You should find that mass loss doesn't even occur anymore; simply stopping accretion halts the redward surge before the nova wind can begin. As a result, recurrence times and SSS phase durations should increase. You could simulate different scenarios where accretion resumes at later and later times by increasing <code>nova_min_Teff_for_accretion</code>, perhaps even setting it to something ludicrously high, like 10<sup>7</sup> K, so that no accretion ever happens during the SSS phase. In this case, we wouldn't expect there to be <em>any</em> M&#775; with stable burning (what <a href="https://ui.adsabs.harvard.edu/abs/2016ApJ...824...22H/abstract" target=_blank>Kato & Hachisu call "enforced novae"</a>).
</p>
<p>
  The super eddington wind prescription, in additon to being poorly resolved in time, suffered from mass loss continuing well into the SSS phase, which if we dug deeper, we would realize would not happen had we not set our surface boundary condition at &tau;=20. We still haven't touched on what changing the spatial resolution would do, or more importantly how convective boundary mixing during the runaway would change things. There are still many experiments to run!
</p>
 -->

      </div>
    </div>      
  </div>
</body>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://code.jquery.com/jquery.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/application.js"></script>
<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
<script type="text/javascript" async src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML'></script>



<script src="/js/mesa-ss-2022.js"></script>

</html>
